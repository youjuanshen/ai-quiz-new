<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å£è¯­é¢è¯•</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* ==================== æ ·å¼åŒº (Lion Style) ==================== */
        body { font-family: 'Comic Sans MS', 'Chalkboard SE', sans-serif; background-color: #e3f2fd; margin: 0; padding: 20px; color: #333; }
        
        /* è¿”å›æŒ‰é’® */
        .home-link { position: fixed; top: 15px; left: 15px; z-index: 1000; background-color: #607d8b; color: white; text-decoration: none; padding: 8px 15px; border-radius: 20px; font-size: 14px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .home-link:hover { background-color: #546e7a; }

        /* å®¹å™¨ */
        .container { max-width: 600px; margin: 0 auto; padding-top: 40px; }
        
        /* å€™è€ƒå®¤å¡ç‰‡ */
        .welcome-card { background: white; border-radius: 20px; padding: 30px; margin: 0 auto; max-width: 500px; box-shadow: 0 8px 20px rgba(0,0,0,0.08); border: 4px solid #fff; text-align: center; }
        .hero-icon { font-size: 60px; margin-bottom: 10px; animation: bounce 2s infinite; }
        .main-title { color: #0288d1; margin: 0 0 20px 0; }
        
        /* é€‰æ‹©å™¨ */
        .selector-group { text-align: left; margin-bottom: 20px; }
        .selector-label { font-weight: bold; color: #555; display: block; margin-bottom: 8px; }
        select { width: 100%; padding: 12px; font-size: 16px; border: 2px solid #e0e0e0; border-radius: 10px; background: #fafafa; outline: none; }
        select:focus { border-color: #0288d1; background: #fff; }
        
        /* å¼€å§‹æŒ‰é’® */
        #startButton { background: #4caf50; color: white; border: none; padding: 15px 40px; border-radius: 30px; font-size: 18px; font-weight: bold; cursor: pointer; width: 100%; box-shadow: 0 4px 10px rgba(76, 175, 80, 0.3); transition: transform 0.1s; }
        #startButton:active { transform: scale(0.95); }
        #startButton:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; }

        /* é¡¶éƒ¨å›ºå®šæ  */
        #fixedHeader { display: none; justify-content: space-between; align-items: center; position: sticky; top: 0; background: rgba(255,255,255,0.95); padding: 10px 20px; z-index: 99; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-radius: 0 0 15px 15px; margin-bottom: 20px; }
        .student-badge { font-weight: bold; color: #333; font-size: 16px; }
        
        /* é¢˜ç›®å¡ç‰‡ */
        .question-page { background: white; border-radius: 16px; padding: 20px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-left: 6px solid #29b6f6; }
        .q-tag { background: #29b6f6; color: white; padding: 4px 10px; border-radius: 10px; font-size: 12px; font-weight: bold; display: inline-block; margin-bottom: 10px; }
        .q-text { font-size: 20px; font-weight: bold; margin: 10px 0 20px 0; line-height: 1.4; color: #263238; }
        .img-box { text-align: center; margin: 15px 0; background: #fafafa; padding: 10px; border-radius: 12px; }
        .img-box img { max-width: 100%; max-height: 250px; border-radius: 8px; }

        /* è€å¸ˆå‚è€ƒåŒº */
        .guide-box { background: #fff3e0; padding: 12px; border-radius: 8px; color: #e65100; margin: 15px 0; font-size: 15px; border: 1px solid #ffe0b2; }
        
        /* è¯„åˆ†æŒ‰é’®ç»„ */
        .score-buttons { display: flex; gap: 5px; margin-top: 15px; }
        .score-btn { flex: 1; padding: 12px 0; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; transition: transform 0.1s; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .score-btn:active { transform: scale(0.95); }
        .score-emoji { font-size: 18px; margin-bottom: 2px; }
        
        .s5 { background: #4caf50; } 
        .s4 { background: #8bc34a; } 
        .s3 { background: #ffc107; color: #4e342e; } 
        .s2 { background: #ff9800; } 
        .s1 { background: #f44336; }

        .feedback { display: none; background: #e8f5e9; color: #2e7d32; padding: 10px; border-radius: 8px; text-align: center; margin-top: 10px; font-weight: bold; border: 1px solid #c8e6c9; }

        /* åº•éƒ¨æ€»åˆ† */
        .footer-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #eee; padding: 15px; text-align: center; box-shadow: 0 -4px 10px rgba(0,0,0,0.05); font-size: 18px; font-weight: bold; color: #333; z-index: 100; }
        .quiz-container { padding-bottom: 80px; }

        .loading { text-align: center; color: #999; margin-top: 10px; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
    </style>
</head>
<body>

<a href="index.html" class="home-link">ğŸ  è¿”å›å¤§å…</a>

<div class="container">
    <div id="coverPage">
        <div class="hero-icon">ğŸ—£ï¸</div>
        <h1 class="main-title">å£è¯­é¢è¯• (è€å¸ˆç«¯)</h1>
        
        <div class="welcome-card">
            <div class="selector-group">
                <label class="selector-label">ğŸ—ºï¸ ç¬¬ä¸€æ­¥ï¼šé€‰æ‹©é¢è¯•å…³å¡</label>
                <select id="quizSelector" onchange="loadSelectedQuiz()">
                    <option value="" disabled selected>-- è¯·é€‰æ‹©å•å…ƒ --</option>
                    </select>
            </div>

            <div class="mission-box" id="statusBox" style="display:none;">
                <div id="missionTitle" class="loading">ç­‰å¾…é€‰æ‹©...</div>
            </div>

            <div class="selector-group" style="margin-top: 20px;">
                <label class="selector-label">ğŸ‘‹ ç¬¬äºŒæ­¥ï¼šé€‰æ‹©è€ƒç”Ÿå§“å</label>
                <select id="studentSelector" onchange="checkStartReady()" disabled>
                    <option value="" disabled selected>-- (è¯·å…ˆé€‰æ‹©å…³å¡) --</option>
                </select>
            </div>
        </div>

        <button id="startButton" disabled onclick="startQuiz()">ğŸš€ å¼€å§‹é¢è¯•</button>
    </div>

    <div id="fixedHeader">
        <div class="header-left">
            <span class="student-badge">ğŸ‘¤ è€ƒç”Ÿ: <span id="studentDisplay" style="color:#0288d1"></span></span>
        </div>
        <div class="header-right">
            <button onclick="location.reload()" style="background:#cfd8dc;border:none;padding:5px 10px;border-radius:15px;cursor:pointer;color:#546e7a;font-size:12px">é‡ç½®</button>
        </div>
    </div>

    <div id="quizContainer" class="quiz-container" style="display:none;"></div>

    <div id="footerBar" class="footer-bar" style="display:none;">
        ğŸŒŸ æ€»åˆ†: <span id="totalScoreDisplay">0</span>
    </div>
</div>

<script>
    // ============================================================
    // ğŸ›ï¸ 1. å…¨å±€é…ç½®åŒº
    // ============================================================
    
    // ğŸ“‹ å£è¯­èœå•é…ç½® (é¢„è®¾ Unit 1 - Unit 4)
    const SPEAKING_MENU = [
        // --- Unit 1 ---
        { label: "Unit 1 Lesson 1: Nice to meet you", path: "data/speaking/u1_l1.js" },
        { label: "Unit 1 Lesson 2: What's your name?", path: "data/speaking/u1_l2.js" },
        { label: "Unit 1 Lesson 3: How are you?", path: "data/speaking/u1_l3.js" },
        { label: "Unit 1 Lesson 4: Have a good day!", path: "data/speaking/u1_l4.js" },
        
        // --- Unit 2 ---
        { label: "Unit 2 Lesson 1: Let's play!", path: "data/speaking/u2_l1.js" },
        { label: "Unit 2 Lesson 2: How many ducks?", path: "data/speaking/u2_l2.js" },
        { label: "Unit 2 Lesson 3: How old are you?", path: "data/speaking/u2_l3.js" },
        { label: "Unit 2 Lesson 4: Phone number", path: "data/speaking/u2_l4.js" },

        // --- Unit 3 ---
        { label: "Unit 3 Lesson 1: It's green", path: "data/speaking/u3_l1.js" },
        { label: "Unit 3 Lesson 2: What color is it?", path: "data/speaking/u3_l2.js" },
        { label: "Unit 3 Lesson 3: Show me red", path: "data/speaking/u3_l3.js" },
        { label: "Unit 3 Lesson 4: Colorful flowers", path: "data/speaking/u3_l4.js" },

        // --- Unit 4 ---
        { label: "Unit 4 Lesson 1: My father", path: "data/speaking/u4_l1.js" },
        { label: "Unit 4 Lesson 2: Who is he?", path: "data/speaking/u4_l2.js" },
        { label: "Unit 4 Lesson 3: Who are they?", path: "data/speaking/u4_l3.js" },
        { label: "Unit 4 Lesson 4: I love my family", path: "data/speaking/u4_l4.js" }
    ];

    // ğŸ“‹ å­¦ç”Ÿåå• (å…¨æ ¡ç»Ÿä¸€ 27äºº)
    const STUDENT_LIST = [
        "1. å¼ å®‡è±ª", "2. å¼ ä½³å¯’", "3. å¼ ç¿æ¸Š", "4. å¼ ç¾½éŸ¬", "5. å¼ ç¾èŒ¹",
        "6. å¼ å˜‰é’¦", "7. å¢æ¢¦å©·", "8. å¼ æ‚¦è±", "9. å¼ è¯­æ¶µ", "10. å¼ è‹±è±ª",
        "11. å¼ å¿—é¹", "12. å¼ æ™ºæ°", "13. å¼ æ¢“å©·", "14. å¼ å“çª", "15. å¼ è¯ºä¾",
        "16. å¼ é›¨æ³½", "17. å¼ ä¾å½¤", "18. å¼ è‰ºæ¥ ", "19. å¼ æ€å½¤", "20. å¼ å­è±ª",
        "21. å¼ æ¢“äº¦", "22. å¼ çš“é‘«", "23. å¼ é›¨æ¬£", "24. å¼ å¦‚æ¬£", "25. å¼ æŸæ¶µ",
        "26. å¼ æ¢“çº¯", "27. å¼ æ³½é‘«"
    ];

    // ğŸ“‹ Google Script URL
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxc8c4prsZZLY9vp-te4gH5twQNO1A8Ek3yROTNZeNs-7YhL60UojvMsQoceJUZ7LUP/exec";

    // ============================================================
    // âš™ï¸ 2. æ ¸å¿ƒé€»è¾‘
    // ============================================================
    
    let currentQuizData = null;
    let totalScore = 0;

    // åˆå§‹åŒ–èœå•
    window.onload = function() {
        const selector = document.getElementById('quizSelector');
        SPEAKING_MENU.forEach(item => {
            const opt = document.createElement('option');
            opt.value = item.path;
            opt.innerText = item.label;
            selector.appendChild(opt);
        });
    };

    // åŠ è½½æ–‡ä»¶
    function loadSelectedQuiz() {
        const filePath = document.getElementById('quizSelector').value;
        if (!filePath) return;

        document.getElementById('statusBox').style.display = 'block';
        document.getElementById('missionTitle').innerText = "â³ æ­£åœ¨è¯»å–é¢˜åº“...";
        document.getElementById('missionTitle').style.color = "#999";

        const script = document.createElement('script');
        script.src = filePath;
        script.onload = () => {
            console.log("Loaded: " + filePath);
            document.getElementById('missionTitle').innerText = "âœ… " + currentQuizData.title;
            document.getElementById('missionTitle').style.color = "#333";
            populateStudents();
            document.getElementById('studentSelector').disabled = false;
        };
        script.onerror = () => {
            document.getElementById('missionTitle').innerText = "âŒ æš‚æ— æ­¤è¯¾é¢˜åº“";
            document.getElementById('missionTitle').style.color = "red";
            alert("è€å¸ˆè¿˜æ²¡ä¸Šä¼ è¿™èŠ‚è¯¾çš„å£è¯­é¢˜å“¦ï¼\n(æ–‡ä»¶æœªæ‰¾åˆ°: " + filePath + ")");
        };
        document.body.appendChild(script);
    }

    // æ¥æ”¶æ•°æ®
    window.LOAD_QUIZ = function(data) {
        currentQuizData = data;
    };

    // å¡«å……åå•
    function populateStudents() {
        const selector = document.getElementById('studentSelector');
        selector.innerHTML = '<option value="" disabled selected>-- ç‚¹å‡»é€‰æ‹© --</option>';
        STUDENT_LIST.forEach(name => {
            const opt = document.createElement('option');
            opt.value = name;
            opt.innerText = name;
            selector.appendChild(opt);
        });
    }

    function checkStartReady() {
        if (document.getElementById('studentSelector').value) {
            document.getElementById('startButton').disabled = false;
        }
    }

    // å¼€å§‹é¢è¯•
    function startQuiz() {
        document.getElementById('coverPage').style.display = 'none';
        document.getElementById('quizContainer').style.display = 'block';
        document.getElementById('fixedHeader').style.display = 'flex';
        document.getElementById('footerBar').style.display = 'block';
        
        totalScore = 0;
        document.getElementById('studentDisplay').textContent = document.getElementById('studentSelector').value;
        document.getElementById('totalScoreDisplay').innerText = "0";
        
        renderQuestions();
    }

    // æ¸²æŸ“é¢˜ç›®
    function renderQuestions() {
        const container = document.getElementById('quizContainer');
        container.innerHTML = '';

        currentQuizData.questions.forEach((q, index) => {
            const qDiv = document.createElement('div');
            qDiv.className = 'question-page';
            qDiv.id = `card-${index}`;
            
            // é¢˜å¹²
            let html = `<div class="q-tag">Q${q.qNum}</div>`;
            html += `<div class="q-text">${q.text}</div>`;

            // å›¾ç‰‡
            let imgSrc = q.imageUri;
            if (q.imageKey && currentQuizData.images) { 
                imgSrc = currentQuizData.images[q.imageKey];
            }
            if (imgSrc) {
                html += `<div class="img-box"><img src="${imgSrc}" alt="Image"></div>`;
            }

            // å‚è€ƒç­”æ¡ˆ
            html += `<div class="guide-box">
                        <div style="font-weight:bold;margin-bottom:5px">ğŸ’¡ å‚è€ƒç­”æ¡ˆï¼š</div>
                        ${q.guide.replace(/\n/g, '<br>')}
                     </div>`;

            // æ‰“åˆ†æŒ‰é’®
            html += `<div id="action-${index}" class="score-buttons">
                        <button onclick="rate(${index}, 5)" class="score-btn s5"><span class="score-emoji">ğŸ¤©</span>5åˆ†</button>
                        <button onclick="rate(${index}, 4)" class="score-btn s4"><span class="score-emoji">ğŸ˜ƒ</span>4åˆ†</button>
                        <button onclick="rate(${index}, 3)" class="score-btn s3"><span class="score-emoji">ğŸ¤”</span>3åˆ†</button>
                        <button onclick="rate(${index}, 2)" class="score-btn s2"><span class="score-emoji">ğŸ˜Ÿ</span>2åˆ†</button>
                        <button onclick="rate(${index}, 1)" class="score-btn s1"><span class="score-emoji">ğŸ˜¶</span>1åˆ†</button>
                     </div>`;
            
            // ç»“æœæ˜¾ç¤ºåŒº
            html += `<div id="fb-${index}" class="feedback"></div>`;

            qDiv.innerHTML = html;
            container.appendChild(qDiv);
        });
    }

    // æ‰“åˆ†ä¸æäº¤é€»è¾‘
    window.rate = function(index, score) {
        document.getElementById(`action-${index}`).style.display = 'none';
        const fb = document.getElementById(`fb-${index}`);
        fb.style.display = 'block';
        
        let comment = "";
        if(score===5) comment="Perfect! ğŸ‰";
        else if(score===4) comment="Good! ğŸ‘";
        else if(score===3) comment="Keep trying! ğŸ’ª";
        else comment="Fight! ğŸ”¥";

        fb.innerHTML = `âœ… å¾—åˆ†ï¼š${score} <span style="font-size:12px;color:#666">(${comment})</span>`;
        
        totalScore += score;
        document.getElementById('totalScoreDisplay').innerText = totalScore;
        
        // è‡ªåŠ¨æ»šåŠ¨åˆ°ä¸‹ä¸€é¢˜
        const nextCard = document.getElementById(`card-${index+1}`);
        if(nextCard) {
            setTimeout(() => nextCard.scrollIntoView({behavior:'smooth', block:'center'}), 400);
        }

        // å¦‚æœæ˜¯æœ€åä¸€é¢˜ï¼Œè‡ªåŠ¨ä¸Šä¼ 
        const totalQ = currentQuizData.questions.length;
        if (index === totalQ - 1) {
            submitDataToGoogle('Speaking', totalScore, "Teacher Rated");
            setTimeout(() => alert("ğŸ‰ é¢è¯•ç»“æŸï¼åˆ†æ•°å·²ä¸Šä¼ ï¼"), 1000);
        }
    }

    // ä¸Šä¼ æ•°æ®
    function submitDataToGoogle(type, score, details) {
        const studentName = document.getElementById('studentSelector').value;
        const payload = {
            studentName: studentName,
            examType: type,
            lessonTitle: currentQuizData.title,
            score: score,
            duration: "N/A", // å£è¯­æš‚ä¸è®¡æ—¶
            details: details
        };
        
        fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        }).then(() => console.log("Uploaded"));
    }
</script>

</body>
</html>
