<script>
    // ------------------------- 0. Google Sheet é…ç½® -------------------------

    // ä½ çš„ Google Apps Script Web App åœ°å€ï¼ˆç›®å‰ç”¨ devï¼Œä¹‹åå¯ä»¥æ¢æˆ /execï¼‰
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxEe9BWBXBpRipPkUJhgdK9eI0nO7WfQTFdMATeoTI/dev';

    // ------------------------- 1. æ•°æ®å®šä¹‰ -------------------------

    // ç¤ºä¾‹å­¦ç”Ÿåå•ï¼ˆä»¥åå¯ä»¥æ”¹æˆä½ è‡ªå·±çš„ï¼‰
    const studentList = [
        { id: '01', name: 'ææ˜' },
        { id: '02', name: 'ç‹èŠ³' },
        { id: '03', name: 'å¼ å°å' },
        { id: '04', name: 'åˆ˜æ´‹' },
        { id: '05', name: 'é™ˆæ€æ€' },
        { id: '06', name: 'èµµä¿Š' },
        { id: '07', name: 'å­™æ‚¦' }
    ];

    // åŸæ¥çš„ SVG å‡½æ•°ï¼ˆç°åœ¨ä¸ç”¨ï¼Œä½†ç•™ç€ä¹Ÿæ²¡å…³ç³»ï¼‰
    function createSimpleSvgDataUri(mainColor, count, label = '') {
        const size = 150;
        const itemSize = 25;
        let items = '';

        if (label) {
            items = `<rect x="5" y="5" width="140" height="140" rx="15" fill="#ffffff" stroke="${mainColor}" stroke-width="3"/>`;
            items += `<text x="${size/2}" y="${size/2 + 25}" font-size="60" font-weight="bold" text-anchor="middle" fill="${mainColor}">${label}</text>`;
        } else {
            const perRow = Math.min(count, 5);
            for (let i = 0; i < count; i++) {
                const row = Math.floor(i / perRow);
                const col = i % perRow;
                const cx = 25 + col * (itemSize + 15);
                const cy = 25 + row * (itemSize + 15);
                items += `<circle cx="${cx}" cy="${cy}" r="${itemSize/2}" fill="${mainColor}" stroke="#333" stroke-width="2"/>`;
            }
            items = `<rect x="2" y="2" width="146" height="146" rx="10" fill="none" stroke="#ddd" stroke-width="1"/>` + items;
        }

        const svg = `<svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}" xmlns="http://www.w3.org/2000/svg" style="background-color: #f0f8ff; border-radius: 8px;">${items}</svg>`;
        const base64Svg = btoa(unescape(encodeURIComponent(svg)));
        return `data:image/svg+xml;base64,${base64Svg}`;
    }

    // ä½¿ç”¨ä½ ä¸Šä¼ åˆ° img/ æ–‡ä»¶å¤¹é‡Œçš„ PNG å›¾ç‰‡
    const imageUris = {
        // æ•°é‡å›¾ç‰‡ï¼š3ã€4ã€5ã€9ã€10ã€2ã€1ã€6 ä¸ªå†°æ¿€å‡Œ
        '3 Items': 'img/num_03.png',
        '4 Items': 'img/num_04.png',
        '5 Items': 'img/num_05.png',
        '9 Items': 'img/num_09.png',
        '10 Items': 'img/num_10.png',
        '2 Items': 'img/num_02.png',
        '1 Item': 'img/num_01.png',
        '6 Items': 'img/num_06.png',

        // Q9 é¢˜å¹²ï¼šç”¨ 4 ä¸ªå†°æ¿€å‡Œæ¥é—® How many ice creams?
        '4 Pencils': 'img/num_04.png',

        // Q10 å…¬å›­åœºæ™¯ï¼šæš‚æ—¶ç”¨ 5 ä¸ªå†°æ¿€å‡Œå ä½ï¼Œä½ ä»¥åå¯ä»¥æ”¹æˆ scene_park.png
        'Park Scene': 'img/num_05.png',

        // Q14 è¡¨æ‰¬ â€œGreat!â€ çš„å¥–ç« 
        'Great Sign': 'img/badge_great.png',

        // Q15 æ˜¾ç¤ºæ•°å­— 5ï¼ŒåŒæ ·ç”¨ num_05
        'Number 5': 'img/num_05.png'
    };

    // æµ‹éªŒé¢˜ç›®æ•°æ®
    const quizData = [
        // Part A: å¬åŠ› (Listening)
        { qNum: 1, part: 'A', type: 'select',
          text: 'è¯·ç‚¹å‡»å°å–‡å­å¬å½•éŸ³ï¼Œç„¶åé€‰æ‹©ä¸å½•éŸ³å†…å®¹åŒ¹é…çš„å›¾ç‰‡ã€‚',
          audioText: 'I have five ice creams.',
          options: [imageUris['3 Items'], imageUris['5 Items'], imageUris['9 Items'], imageUris['4 Items']],
          correct: imageUris['5 Items'],
          hint: 'æ³¨æ„æ•°å­— five å¯¹åº”å“ªä¸ªæ•°é‡ã€‚'
        },
        { qNum: 2, part: 'A', type: 'select',
          text: 'è¯·ç‚¹å‡»å°å–‡å­å¬å½•éŸ³ï¼Œç„¶åé€‰æ‹©ä¸å½•éŸ³å†…å®¹åŒ¹é…çš„å›¾ç‰‡ã€‚',
          audioText: 'Count the number to ten.',
          options: [imageUris['4 Items'], imageUris['5 Items'], imageUris['10 Items'], imageUris['2 Items']],
          correct: imageUris['10 Items'],
          hint: 'ä»”ç»†å¬æ•°å­—è¯ ten çš„å‘éŸ³ã€‚'
        },
        { qNum: 3, part: 'A', type: 'select',
          text: 'è¯·ç‚¹å‡»å°å–‡å­å¬å½•éŸ³ï¼Œç„¶åé€‰æ‹©ä¸å½•éŸ³å†…å®¹åŒ¹é…çš„ä¸­æ–‡æ„æ€ã€‚',
          audioText: "Let's play a game!",
          options: ['è®©æˆ‘ä»¬ç©æ¸¸æˆï¼', 'ä½ å«ä»€ä¹ˆåå­—ï¼Ÿ', 'è¿™æ˜¯æˆ‘çš„æœ‹å‹ã€‚', 'å¾ˆé«˜å…´è§åˆ°ä½ ï¼'],
          correct: 'è®©æˆ‘ä»¬ç©æ¸¸æˆï¼',
          hint: "å¥å‹ Let's ... è¡¨ç¤ºâ€œè®©æˆ‘ä»¬â€¦â€¦â€çš„æ„æ€ã€‚"
        },
        { qNum: 4, part: 'A', type: 'fill',
          text: 'è¯·ç‚¹å‡»å°å–‡å­å¬å½•éŸ³ï¼Œç„¶åè¾“å…¥å•è¯æ‹¼å†™ã€‚',
          audioText: 'The number is three.',
          correct: 'three',
          hint: 'è¿™ä¸ªæ•°å­—è¯ä»¥ t å¼€å¤´ã€‚'
        },
        { qNum: 5, part: 'A', type: 'fill',
          text: 'è¯·ç‚¹å‡»å°å–‡å­å¬å½•éŸ³ï¼Œç„¶åè¾“å…¥å•è¯æ‹¼å†™ã€‚',
          audioText: "OK, Let's play!",
          correct: 'play',
          hint: 'è¿™ä¸ªå•è¯æ˜¯è¡¨ç¤ºâ€œç©è€â€çš„åŠ¨è¯ã€‚'
        },

        // Part B: é˜…è¯» (Reading)
        { qNum: 6, part: 'B', type: 'drag-sort',
          text: 'è¯·å°†ä¸‹åˆ—è¯å—æ‹–æ‹½æ’åºï¼Œç»„æˆä¸€ä¸ªæ­£ç¡®çš„å¥å­ã€‚',
          words: ['apple', 'is', 'This', 'an', '.'],
          correct: 'This is an apple.',
          hint: 'å¥å‹ This is an...'
        },
        { qNum: 7, part: 'B', type: 'drag-sort',
          text: 'è¯·å°†ä¸‹åˆ—è¯å—æ‹–æ‹½æ’åºï¼Œç»„æˆä¸€ä¸ªæ­£ç¡®çš„å¥å­ã€‚',
          words: ['park.', "Let's", 'in the', 'play'],
          correct: "Let's play in the park.",
          hint: "å¥å­ Let's å¼€å¤´ã€‚"
        },
        { qNum: 8, part: 'B', type: 'select',
          text: 'è¯·é€‰æ‹©ä¸è‹±æ–‡æ•°å­—è¯æ±‡ "six" å¯¹åº”çš„æ•°é‡å›¾ç‰‡ã€‚',
          options: [imageUris['1 Item'], imageUris['9 Items'], imageUris['6 Items'], imageUris['2 Items']],
          correct: imageUris['6 Items'],
          hint: 'æ•°å­— six æ˜¯å‡ ï¼Ÿ'
        },
        { qNum: 9, part: 'B', type: 'fill',
          text: 'çœ‹å›¾å›ç­”é—®é¢˜ï¼Œç”¨ä¸€ä¸ªè‹±æ–‡å•è¯ä½œç­”ï¼šHow many ice creams?',
          imageUri: imageUris['4 Pencils'],
          correct: 'four',
          hint: 'å›¾ç‰‡ä¸­æ˜¯ 4 ä¸ªå†°æ¿€å‡Œã€‚'
        },
        { qNum: 10, part: 'B', type: 'select',
          text: 'çœ‹å›¾ï¼Œé€‰å‡ºè¿™ä¸ªåœºæ™¯å¯¹åº”çš„è‹±æ–‡å•è¯ã€‚',
          imageUri: imageUris['Park Scene'],
          options: ['school', 'park', 'home', 'zoo'],
          correct: 'park',
          hint: 'è¿™ä¸ªå•è¯æ˜¯ Unit 2 å­¦ä¹ çš„åœºæ™¯è¯ã€‚'
        },

        // Part C: å†™ä½œ (Writing)
        { qNum: 11, part: 'C', type: 'select',
          text: 'è¯·é€‰æ‹©æ•°å­— 7 å¯¹åº”çš„æ­£ç¡®è‹±æ–‡æ‹¼å†™ã€‚',
          options: ['seven', 'sevan', 'sewen', 'seve'],
          correct: 'seven',
          hint: 'è¯·å›å¿† seven çš„å…ƒéŸ³å­—æ¯ã€‚'
        },
        { qNum: 12, part: 'C', type: 'drag-sort',
          text: 'è¯·æ‹–æ‹½è¯å—ï¼Œå®Œæˆå¥å­ï¼šI can ___ the ___ from one to ten.',
          words: ['say', 'numbers', 'play', 'go'],
          correct: 'I can say the numbers from one to ten.',
          hint: 'â€œè¯´æ•°å­—â€çš„è‹±æ–‡æ˜¯ä»€ä¹ˆï¼Ÿ'
        },
        { qNum: 13, part: 'C', type: 'fill',
          text: 'è¯·æ‹¼å†™å‡ºæ•°å­— 8 çš„è‹±æ–‡å•è¯ã€‚',
          correct: 'eight',
          hint: 'è¿™ä¸ªå•è¯ä»¥ e å¼€å¤´ã€‚'
        },
        { qNum: 14, part: 'C', type: 'fill',
          text: 'çœ‹å›¾ï¼Œå½“ä½ è¯´â€œå¤ªæ£’äº†â€æ—¶ï¼Œå¯¹åº”çš„è‹±æ–‡å•è¯æ˜¯ä»€ä¹ˆï¼Ÿ',
          imageUri: imageUris['Great Sign'],
          correct: 'great',
          hint: 'è¿™æ˜¯ä¸€ä¸ªè¡¨ç¤ºèµæ‰¬çš„å•è¯ï¼Œä»¥ g å¼€å¤´ã€‚'
        },
        { qNum: 15, part: 'C', type: 'fill',
          text: "æ ¹æ®å›¾ç‰‡ (æ•°å­— 5)ï¼Œè¯·å®Œæˆå¥å­ï¼šIt's number _____ .",
          imageUri: imageUris['Number 5'],
          correct: 'five',
          hint: 'è¿™ä¸ªæ•°å­—æ˜¯ä»¥ f å¼€å¤´çš„ã€‚'
        }
    ];

    // ------------------------- 2. çŠ¶æ€å˜é‡ -------------------------

    let currentQuestionIndex = 1;
    const TOTAL_QUESTIONS = quizData.length;
    let timerInterval;
    let timeLeft = 540; // 9 åˆ†é’Ÿ
    let currentAnswers = {};
    let allStudentRecords = [];
    let draggedItem = null;

    // ------------------------- 3. æ ¸å¿ƒåŠŸèƒ½å‡½æ•° -------------------------

    // åˆå§‹åŒ–å­¦ç”Ÿä¸‹æ‹‰èœå•
    function populateStudents() {
        const selector = document.getElementById('studentSelector');
        studentList.forEach(student => {
            const option = document.createElement('option');
            option.value = student.id;
            option.textContent = `${student.id.padStart(2, '0')} ${student.name}`;
            selector.appendChild(option);
        });
        document.getElementById('exportButton').style.display = 'none';
    }

    // å¯ç”¨å¼€å§‹æŒ‰é’®
    function enableStartButton() {
        const selector = document.getElementById('studentSelector');
        const startButton = document.getElementById('startButton');
        if (selector.value) {
            startButton.disabled = false;
            startButton.style.backgroundColor = '#007bff';
            startButton.style.boxShadow = '0 4px 8px rgba(0, 123, 255, 0.4)';
        } else {
            startButton.disabled = true;
            startButton.style.backgroundColor = '#ccc';
            startButton.style.boxShadow = 'none';
        }
    }

    // å¯åŠ¨æµ‹éªŒ
    function startQuiz() {
        const studentId = document.getElementById('studentSelector').value;
        if (!studentId) {
            alert('è¯·å…ˆé€‰æ‹©ä½ çš„å§“åï¼');
            return;
        }

        renderAllQuestions();

        document.getElementById('coverPage').style.display = 'none';
        document.getElementById('quizContainer').style.display = 'block';
        document.getElementById('scoreCard').style.display = 'none';

        currentAnswers = {};
        timeLeft = 540;
        currentQuestionIndex = 1;

        const selectedStudent = studentList.find(s => s.id === studentId);
        document.getElementById('studentDisplay').textContent = `åŒå­¦ï¼š${selectedStudent.name}`;
        document.getElementById('fixedHeader').style.display = 'flex';

        startTimer();
        changeQuestion(1);
    }

    // è®¡æ—¶å™¨å‡½æ•°
    function startTimer() {
        clearInterval(timerInterval);
        const timerDisplay = document.getElementById('timerDisplay');

        timerInterval = setInterval(() => {
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                timerDisplay.textContent = '00:00';
                alert('æ—¶é—´åˆ°ï¼ç³»ç»Ÿå°†è‡ªåŠ¨æäº¤ç­”å·ã€‚');
                submitAnswers();
                return;
            }

            timeLeft--;
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }, 1000);
    }

    // åˆ‡æ¢é¢˜ç›®åˆ†é¡µ
    function changeQuestion(newIndex) {
        if (newIndex < 1 || newIndex > TOTAL_QUESTIONS) return;

        document.querySelectorAll('.question-page').forEach(el => el.style.display = 'none');
        currentQuestionIndex = newIndex;

        const newElement = document.getElementById(`question_page_${currentQuestionIndex}`);
        if (newElement) {
            newElement.style.display = 'block';
            window.scrollTo(0, 0);
        }
    }

    // æ¸²æŸ“æ‰€æœ‰é¢˜ç›®åˆ° DOM ä¸­ï¼ˆæ”¯æŒ img/ è·¯å¾„å›¾ç‰‡ï¼‰
    function renderAllQuestions() {
        const container = document.getElementById('quizContainer');
        const scoreCard = document.getElementById('scoreCard');
        const fixedHeader = document.getElementById('fixedHeader');

        // æ¸…é™¤æ—§é¢˜ç›®ï¼ˆä¿ç•™å¤´éƒ¨å’Œæˆç»©å¡ç‰‡ï¼‰
        let removeList = [];
        Array.from(container.children).forEach(child => {
            if (child !== fixedHeader && child !== scoreCard) {
                removeList.push(child);
            }
        });
        removeList.forEach(child => container.removeChild(child));

        // é€é¢˜ç”Ÿæˆ
        quizData.forEach(q => {
            const qDiv = document.createElement('div');
            qDiv.id = `question_page_${q.qNum}`;
            qDiv.className = 'question-page';
            qDiv.style.display = 'none';

            let html = `<h3>Part ${q.part} - Q${q.qNum} (5åˆ†)</h3>`;
            html += `<div class="question-content" style="margin-bottom: 20px;">${q.text}</div>`;

            // é¢˜å¹²å›¾ç‰‡
            if (q.imageUri) {
                html += `<img src="${q.imageUri}" alt="é¢˜ç›®æ’å›¾" class="question-image-style">`;
            }

            if (q.type === 'select') {
                if (q.audioText) {
                    const safeText = q.audioText.replace(/'/g, "\\'");
                    html += `<button class="speaker-button" onclick="speakText('${safeText}')">ğŸ”Š æ’­æ”¾è¯­éŸ³: ${q.audioText.length < 20 ? q.audioText : 'ç‚¹å‡»æ”¶å¬'}</button>`;
                }

                q.options.forEach(option => {
                    // åˆ¤æ–­é€‰é¡¹æ˜¯ä¸æ˜¯å›¾ç‰‡ï¼šä»¥ "img/" æˆ– "data:image" å¼€å¤´
                    const isImage = (typeof option === 'string') &&
                        (option.indexOf('img/') === 0 || option.indexOf('data:image') === 0);

                    const displayContent = isImage
                        ? `<img src="${option}" alt="é€‰é¡¹å›¾" class="option-image-style">`
                        : `<span class="answer-option-text">${option}</span>`;

                    const valueForData = option.toString().replace(/"/g, "&quot;");
                    const valueForClick = option.toString().replace(/'/g, "\\'");

                    html += `
                        <div class="answer-option" data-qnum="${q.qNum}" data-value="${valueForData}"
                             onclick="collectSelectAnswer(${q.qNum}, '${valueForClick}', this)">
                            ${displayContent}
                        </div>
                    `;
                });

            } else if (q.type === 'fill') {
                if (q.audioText) {
                    const safeText = q.audioText.replace(/'/g, "\\'");
                    html += `<button class="speaker-button" onclick="speakText('${safeText}')">ğŸ”Š æ’­æ”¾è¯­éŸ³: ${q.audioText.length < 20 ? q.audioText : 'ç‚¹å‡»æ”¶å¬'}</button>`;
                }
                html += `<input type="text" id="answer_Q${q.qNum}" class="fill-in-input"
                               oninput="collectFillAnswer(${q.qNum})"
                               placeholder="åœ¨æ­¤è¾“å…¥è‹±æ–‡å•è¯ (é™å°å†™)">`;

            } else if (q.type === 'drag-sort') {
                html += `<div id="sort_target_Q${q.qNum}" class="drag-target"
                              ondrop="dropSort(event, ${q.qNum})" ondragover="allowDrop(event)">
                             å°†è¯å—æ‹–æ‹½åˆ°æ­¤å¤„æ’åº
                         </div>`;
                html += `<h4>å¯é€‰è¯å—:</h4><div id="sort_source_Q${q.qNum}" style="margin-top: 10px;">`;
                q.words.forEach((item, index) => {
                    html += `<div id="sort_item_Q${q.qNum}_${index}" class="drag-item" draggable="true"
                                  data-value="${item.trim()}" ondragstart="dragStart(event)">${item}</div>`;
                });
                html += `</div>`;
            }

            // åˆ†é¡µæŒ‰é’®
            html += `<div class="navigation-buttons">`;
            if (q.qNum > 1) {
                html += `<button class="prev-button" onclick="changeQuestion(${q.qNum - 1})">ä¸Šä¸€é¢˜</button>`;
            }
            if (q.qNum < TOTAL_QUESTIONS) {
                html += `<button class="next-button" onclick="changeQuestion(${q.qNum + 1})">ä¸‹ä¸€é¢˜</button>`;
            } else {
                html += `<button class="submit-button" onclick="submitAnswers()">æäº¤ç­”å·</button>`;
            }
            html += `</div>`;

            qDiv.innerHTML = html;
            container.insertBefore(qDiv, scoreCard);
        });
    }

    // ------------------------- 4. ç­”æ¡ˆæ”¶é›†ä¸è¯„åˆ† -------------------------

    function collectSelectAnswer(qNum, value, element) {
        document.querySelectorAll(`.answer-option[data-qnum="${qNum}"]`).forEach(opt => {
            opt.classList.remove('selected-option');
        });
        element.classList.add('selected-option');
        currentAnswers[`Q${qNum}`] = value;
    }

    function collectFillAnswer(qNum) {
        const inputElement = document.getElementById(`answer_Q${qNum}`);
        if (inputElement) {
            const value = inputElement.value.trim().toLowerCase();
            currentAnswers[`Q${qNum}`] = value;
        }
    }

    function collectDragSortAnswer(qNum) {
        const target = document.getElementById(`sort_target_Q${qNum}`);
        let sortedAnswer = '';
        Array.from(target.children).forEach(item => {
            if (item.classList.contains('drag-item')) {
                sortedAnswer += item.getAttribute('data-value') + ' ';
            }
        });
        currentAnswers[`Q${qNum}`] = sortedAnswer.trim();
    }

    // è¯„åˆ†ï¼šè¿”å›æ€»åˆ†ã€å„é¢˜å¯¹é”™ã€ä¸‰éƒ¨åˆ†åˆ†æ•°
    function gradeQuiz(answers) {
        let score = 0;
        let correctness = {};

        let listeningScore = 0;
        let readingScore = 0;
        let writingScore = 0;

        quizData.forEach(q => {
            const qKey = `Q${q.qNum}`;
            let isCorrect = false;
            const studentAnswer = answers[qKey] || '';

            if (q.type === 'select' || q.type === 'fill') {
                isCorrect = (studentAnswer.toLowerCase() === q.correct.toLowerCase());
            } else if (q.type === 'drag-sort') {
                const cleanedStudent = studentAnswer.toLowerCase().replace(/[.,?!]/g, '').replace(/\s+/g, ' ');
                const cleanedCorrect = q.correct.toLowerCase().replace(/[.,?!]/g, '').replace(/\s+/g, ' ');
                isCorrect = (cleanedStudent === cleanedCorrect);
            }

            if (isCorrect) {
                score += 5;
                if (q.part === 'A') listeningScore += 5;
                else if (q.part === 'B') readingScore += 5;
                else if (q.part === 'C') writingScore += 5;
            }
            correctness[qKey] = isCorrect;
        });

        return { score, correctness, listeningScore, readingScore, writingScore };
    }

    // ------------------------- 5. å†™å…¥ Google Sheet + æäº¤é€»è¾‘ -------------------------

    // æŠŠæ±‡æ€»æˆç»©å‘é€åˆ° Google Sheet
    function sendSummaryToGoogleSheet(summary) {
        try {
            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors', // åªå‘é€ï¼Œä¸è¯»è¿”å›
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(summary)
            }).catch(function (err) {
                console.error('å‘é€åˆ° Google Sheet å¤±è´¥ï¼ˆfetch errorï¼‰:', err);
            });
        } catch (err) {
            console.error('å‘é€åˆ° Google Sheet å¤±è´¥ï¼ˆtry-catchï¼‰:', err);
        }
    }

    function submitAnswers() {
        clearInterval(timerInterval);

        // å…ˆæ”¶é›†æ‹–æ‹½é¢˜ç­”æ¡ˆ
        quizData.filter(q => q.type === 'drag-sort').forEach(q => {
            collectDragSortAnswer(q.qNum);
        });

        // å¾—åˆ°æ€»åˆ† + å„éƒ¨åˆ†åˆ†æ•°
        const result = gradeQuiz(currentAnswers);
        const score = result.score;
        const correctness = result.correctness;
        const listeningScore = result.listeningScore;
        const readingScore = result.readingScore;
        const writingScore = result.writingScore;

        const studentId = document.getElementById('studentSelector').value;
        const selector = document.getElementById('studentSelector');
        const optionText = selector.options[selector.selectedIndex].textContent; // ä¾‹å¦‚ "01 ææ˜"
        const parts = optionText.split(' ');
        const studentName = parts[1] || optionText;      // å§“å
        const studentLabel = (parts[0] || '') + (parts[1] || ''); // ä¾‹å¦‚ "01ææ˜"ï¼Œæ–¹ä¾¿å¯¹ä¸Šä½ è¡¨é‡Œçš„â€œ01å¼ å®‡è±ªâ€

        // æ€»åˆ† 75 åˆ†ï¼Œç®—æ€»ç™¾åˆ†æ¯”
        const totalPercent = Math.round(score / (TOTAL_QUESTIONS * 5) * 100);

        // æœ¬åœ°è®°å½•ï¼ˆç”¨äº CSVï¼‰
        const record = {
            studentId,
            name: studentName,
            score,
            answers: { ...currentAnswers },
            correctness,
            listeningScore,
            readingScore,
            writingScore,
            totalPercent
        };
        allStudentRecords.push(record);

        // å‘ä¸€ä»½æ±‡æ€»æ•°æ®åˆ° Google Sheetï¼ˆå¯¹åº”ä½ ç°åœ¨è¡¨æ ¼çš„ 7 åˆ—ï¼‰
        const summaryForSheet = {
            studentLabel: studentLabel,      // B åˆ—ï¼šå­¦ç”Ÿå§“åï¼ˆå«ç¼–å·ï¼‰
            totalScore: score,               // C åˆ—ï¼šæ€»åˆ†
            totalPercent: totalPercent,      // D åˆ—ï¼šæ€»ç™¾åˆ†æ¯”
            listeningScore: listeningScore,  // E åˆ—ï¼šå¬åŠ›å¾—åˆ†
            readingScore: readingScore,      // F åˆ—ï¼šé˜…è¯»å¾—åˆ†
            writingScore: writingScore       // G åˆ—ï¼šå†™ä½œå¾—åˆ†
        };
        sendSummaryToGoogleSheet(summaryForSheet);

        // å‰ç«¯æ˜¾ç¤ºæˆç»©å¡ç‰‡
        displayScoreCard(score, studentName);

        if (allStudentRecords.length > 0) {
            document.getElementById('exportButton').style.display = 'block';
        }
    }

    function displayScoreCard(score, name) {
        document.getElementById('fixedHeader').style.display = 'none';
        document.querySelectorAll('.question-page').forEach(el => el.style.display = 'none');

        const scoreCard = document.getElementById('scoreCard');
        scoreCard.style.display = 'block';

        let grade = '';
        let feedback = '';

        if (score >= 60) {
            grade = 'A (ä¼˜ç§€)';
            feedback = `ğŸ‰ æ£’æäº†ï¼Œ${name}ï¼ä½ å¯¹æ•°å­—å’Œå¥å‹æŒæ¡å¾—éå¸¸å¥½ï¼`;
        } else if (score >= 40) {
            grade = 'B (è‰¯å¥½)';
            feedback = `ğŸŒŸ ${name}ï¼Œä½ åšå¾—å¾ˆå¥½ï¼å†å›é¡¾ä¸€ä¸‹æ•°å­—çš„æ‹¼å†™å“¦ã€‚`;
        } else {
            grade = 'C (éœ€åŠªåŠ›)';
            feedback = `ğŸ’¡ ${name}ï¼Œç»§ç»­åŠ æ²¹ï¼è¯·åœ¨è¯¾åå¤šå¬å¤šè¯»æ•°å­—è¯æ±‡ã€‚`;
        }

        document.getElementById('finalScore').innerHTML =
            `ä½ çš„å¾—åˆ†: <span style="color: #dc3545; font-size: 1.5em; font-weight: bold;">${score}</span> / 75 åˆ† (${grade})`;
        document.getElementById('gradeFeedback').textContent = feedback;
    }

    function resetForNextStudent() {
        document.getElementById('quizContainer').style.display = 'none';
        document.getElementById('coverPage').style.display = 'flex';
        document.getElementById('scoreCard').style.display = 'none';
        document.getElementById('studentSelector').value = '';
        document.getElementById('startButton').disabled = true;
        document.getElementById('startButton').style.backgroundColor = '#ccc';
        window.scrollTo(0, 0);
    }

    // ------------------------- 6. è¾…åŠ©åŠŸèƒ½ï¼šè¯­éŸ³ & æ‹–æ‹½ -------------------------

    function speakText(text) {
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.9;
            utterance.pitch = 1.0;
            utterance.lang = 'en-US';
            window.speechSynthesis.speak(utterance);
        } else {
            alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³æœ—è¯»åŠŸèƒ½ã€‚');
        }
    }

    function dragStart(event) {
        draggedItem = event.target;
        event.dataTransfer.setData('text/plain', draggedItem.id);
        setTimeout(() => {
            draggedItem.style.opacity = '0.5';
        }, 0);
    }

    function allowDrop(event) {
        event.preventDefault();
    }

    function dropSort(event, qNum) {
        event.preventDefault();
        if (!draggedItem) return;

        draggedItem.style.opacity = '1';

        if (draggedItem.classList.contains('drag-item')) {
            const target = event.currentTarget;

            if (target.id.startsWith('sort_target_Q')) {
                target.appendChild(draggedItem);
            } else if (target.classList.contains('drag-item')) {
                target.parentNode.insertBefore(draggedItem, target);
            } else if (target.id.startsWith('sort_source_Q')) {
                target.appendChild(draggedItem);
            }

            collectDragSortAnswer(qNum);
        }
    }

    // ------------------------- 7. CSV å¯¼å‡ºé€»è¾‘ -------------------------

    function exportToCSV() {
        if (allStudentRecords.length === 0) {
            alert('è¿˜æ²¡æœ‰å­¦ç”Ÿæäº¤ç­”å·å“¦ï¼');
            return;
        }

        const headerFields = ['å­¦å·', 'å§“å', 'æ€»å¾—åˆ†'];
        for (let i = 1; i <= TOTAL_QUESTIONS; i++) {
            headerFields.push(`Answer_Q${i}`);
            headerFields.push(`Correct_Q${i}`);
        }

        let csvContent = headerFields.join(',') + '\n';

        allStudentRecords.forEach(record => {
            let row = [
                `"${record.studentId}"`,
                `"${record.name}"`,
                record.score
            ];

            for (let i = 1; i <= TOTAL_QUESTIONS; i++) {
                const qKey = `Q${i}`;
                let answer = record.answers[qKey] ? record.answers[qKey].toString().replace(/"/g, '""') : '';
                row.push(`"${answer}"`);

                const correctness = record.correctness[qKey] ? 'Yes' : 'No';
                row.push(correctness);
            }

            csvContent += row.join(',') + '\n';
        });

        const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.setAttribute('href', url);
        a.setAttribute('download', `è‹±è¯­å°æµ‹æˆç»©_${new Date().toISOString().slice(0, 10)}.csv`);

        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        alert(`å·²æˆåŠŸå¯¼å‡º ${allStudentRecords.length} æ¡å­¦ç”Ÿæˆç»©ï¼`);
    }

    // ------------------------- 8. åˆå§‹åŒ– -------------------------

    document.addEventListener('DOMContentLoaded', () => {
        populateStudents();
    });
</script>
