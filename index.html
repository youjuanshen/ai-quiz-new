<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>ä¸‰å¹´çº§ä¸Š U1 L4 Quiz - Listening & Reading & Writing</title>
  <style>
    /* æ•´ä½“èƒŒæ™¯ï¼šæŸ”å’Œæ¸å˜ï¼Œé€‚åˆå°æœ‹å‹ */
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 600px;
      margin: 0 auto;
      padding: 12px;
      line-height: 1.5;
      background: linear-gradient(180deg, #f5fbff 0%, #fff8e6 100%);
    }

    h1 {
      font-size: 1.6rem;
      margin: 0.8em 0 0.4em;
    }

    .note {
      font-size: 0.85rem;
      color: #555;
    }

    /* å°é¢æ•´ä½“å¸ƒå±€ */
    .cover {
      text-align: center;
      margin-top: 12px;
      padding: 4px 4px 16px;
    }

    .cover-emoji {
      font-size: 2.4rem;
      margin-bottom: 4px;
    }

    .cover-title {
      font-size: 1.5rem;
      margin: 4px 0 2px;
    }

    .cover-subtitle {
      font-size: 1rem;
      color: #555;
      margin-bottom: 10px;
    }

    /* å°é¢ä¸­é—´å¡ç‰‡ */
    .cover-card {
      background: #fffdf4;
      border-radius: 16px;
      padding: 16px 14px 18px;
      margin-top: 4px;
      border: 1px solid #f3e1a4;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
    }

    .cover-text {
      font-size: 0.95rem;
      line-height: 1.6;
      margin-bottom: 10px;
    }

    .cover-field {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      margin: 8px 0 10px;
      flex-wrap: wrap;
    }

    .cover-label {
      font-size: 0.95rem;
    }

    .cover-select {
      min-width: 210px;
      padding: 6px 8px;
      font-size: 0.95rem;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    .cover-tip {
      font-size: 0.9rem;
      color: #555;
      line-height: 1.6;
      margin: 6px 0 10px;
    }

    .cover-start-btn {
      width: 100%;
      padding: 10px 14px;
      border-radius: 999px;
      border: none;
      background: #ff9f4a;
      color: #ffffff;
      font-size: 1.05rem;
      font-weight: 600;
      letter-spacing: 0.5px;
      box-shadow: 0 3px 6px rgba(255, 159, 74, 0.4);
    }

    .cover-start-btn:active {
      transform: scale(0.97);
      box-shadow: 0 1px 3px rgba(255, 159, 74, 0.3);
    }

    /* ç­”é¢˜é¡µé¡¶éƒ¨æ¡ */
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      padding: 6px 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 0.9rem;
      background-color: #ffffffcc;
    }

    #timer {
      font-weight: bold;
    }

    /* ä¸€é¢˜ä¸€å±ï¼šé¢˜å¡ */
    #quiz-page {
      margin-top: 8px;
    }

    #question-container {
      margin-top: 10px;
    }

    .question-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 10px 12px 12px;
      margin-bottom: 8px;
      display: none;
      font-size: 0.95rem;
      background: #ffffff;
    }

    .question-card.active {
      display: block;
    }

    .q-header {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .q-part {
      font-size: 0.8rem;
      color: #777;
      margin-bottom: 4px;
    }

    .q-body p {
      margin: 4px 0;
    }

    .play-btn {
      margin: 4px 0 6px;
      padding: 4px 8px;
      font-size: 0.85rem;
    }

    .options label {
      display: block;
      margin: 3px 0;
    }

    /* åº•éƒ¨å¯¼èˆªæŒ‰é’® */
    .q-nav {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      margin-top: 10px;
    }

    .q-nav button {
      flex: 1;
      padding: 8px 10px;
      font-size: 0.9rem;
    }

    /* ç»“æœä¸è€å¸ˆå·¥å…· */
    #result-box {
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 6px;
      border: 1px solid #ddd;
      display: none;
      font-size: 0.9rem;
      background-color: #ffffff;
    }

    #result-text {
      font-weight: bold;
      margin-bottom: 4px;
    }

    #teacher-tools {
      margin-top: 10px;
      font-size: 0.85rem;
      display: none;
    }

    #teacher-tools button {
      margin-top: 6px;
      padding: 6px 10px;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <!-- å°é¢åŒºåŸŸ -->
  <div id="cover-page" class="cover">
    <div class="cover-emoji">ğŸ“šâœ¨</div>
    <h1 class="cover-title">ä¸‰å¹´çº§ U1 L4 è‹±è¯­å°æµ‹éªŒ</h1>
    <p class="cover-subtitle">Welcome! æ¬¢è¿å‚åŠ æˆ‘ä»¬çš„è‹±è¯­å°æµ‹éªŒï½</p>

    <div id="cover-card" class="cover-card">
      <p class="cover-text">
        ğŸ˜Š è¯·å…ˆåœ¨ä¸‹é¢æ‰¾åˆ°å¹¶é€‰ä¸­<strong>ä½ çš„åå­—</strong>ã€‚<br>
        ğŸŒŸ å‡†å¤‡å¥½äº†ï¼Œå°±ç‚¹å‡»ä¸‹é¢çš„å¤§æŒ‰é’®å¼€å§‹å§ï½
      </p>

      <div class="cover-field">
        <label for="studentSelect" class="cover-label">æˆ‘çš„åå­—ï¼š</label>
        <select id="studentSelect" class="cover-select">
          <option value="" selected disabled>ç‚¹è¿™é‡Œé€‰æ‹©å§“å</option>
          <!-- å­¦ç”Ÿåå• -->
          <option value="01">01å¼ å®‡è±ª</option>
          <option value="02">02å¼ ä½³å¯’</option>
          <option value="03">03å¼ ç¿æ¸Š</option>
          <option value="04">04å¼ ç¾½éŸ¬</option>
          <option value="05">05å¼ ç¾èŒ¹</option>
          <option value="06">06å¼ å˜‰é’¦</option>
          <option value="07">07å¢æ¢¦å©·</option>
          <option value="08">08å¼ æ‚¦è±</option>
          <option value="09">09å¼ è¯­æ¶µ</option>
          <option value="10">10å¼ è‹±è±ª</option>
          <option value="11">11å¼ å¿—é¹</option>
          <option value="12">12å¼ æ™ºæ°</option>
          <option value="13">13å¼ æ¢“å©·</option>
          <option value="14">14å¼ å“çª</option>
          <option value="15">15å¼ è¯ºä¾</option>
          <option value="16">16å¼ é›¨æ³½</option>
          <option value="17">17å¼ ä¾å½¤</option>
          <option value="18">18å¼ è‰ºæ¥ </option>
          <option value="19">19å¼ æ€å½¤</option>
          <option value="20">20å¼ å­è±ª</option>
          <option value="21">21å¼ æ¢“äº¦</option>
          <option value="22">22å¼ çš“é‘«</option>
          <option value="23">23å¼ é›¨æ¬£</option>
          <option value="24">24å¼ å¦‚æ¬£</option>
          <option value="25">25å¼ æŸæ¶µ</option>
          <option value="26">26å¼ æ¢“çº¯</option>
          <option value="27">27å¼ æ³½é‘«</option>
        </select>
      </div>

      <p class="cover-tip">
        â± æ¯ä½åŒå­¦æœ‰ <strong>9 åˆ†é’Ÿ</strong> å®Œæˆè¿™ä»½å°æµ‹éªŒï¼Œ<br>
        è®¡æ—¶ä¼šåœ¨ä½ ç‚¹å‡»â€œå¼€å§‹ç­”é¢˜â€ä¹‹åæ‰æ…¢æ…¢èµ°åŠ¨ã€‚<br>
        æ”¾è½»æ¾ï¼Œä¸€é¢˜ä¸€é¢˜æ¥ï¼Œå°±èƒ½åšå¾—å¾ˆæ£’å“¦ï¼ğŸ’ª
      </p>

      <button id="enterBtn" class="cover-start-btn">
        âœ¨ å¼€å§‹ç­”é¢˜ï¼ˆæˆ‘å‡†å¤‡å¥½äº†ï¼ï¼‰
      </button>
    </div>
  </div>

  <!-- ç­”é¢˜é¡µï¼šä¸€é¢˜ä¸€å± -->
  <div id="quiz-page" style="display:none;">
    <div class="top-bar">
      <div>å­¦ç”Ÿï¼š<span id="studentNameDisplay"></span></div>
      <div>å‰©ä½™æ—¶é—´ï¼š<span id="timer">09:00</span></div>
    </div>

    <div id="question-container">
      <!-- Listening Q1 -->
      <div class="question-card" data-qindex="1">
        <div class="q-part">Part A Â· Listening Â· Q1/5</div>
        <div class="q-header">1. å¬å¥å­ï¼Œé€‰å‡ºä½ å¬åˆ°çš„é—®å€™è¯­ã€‚</div>
        <div class="q-body">
          <button type="button" class="play-btn" data-tts="Good morning.">â–¶ æ’­æ”¾</button>
          <div class="options">
            <label><input type="radio" name="L1" value="A"> Good morning.</label>
            <label><input type="radio" name="L1" value="B"> Good afternoon.</label>
            <label><input type="radio" name="L1" value="C"> Goodbye.</label>
          </div>
        </div>
        <div class="q-nav">
          <button disabled>ä¸Šä¸€é¢˜</button>
          <button type="button" onclick="goNext()">ä¸‹ä¸€é¢˜</button>
        </div>
      </div>

      <!-- Listening Q2 -->
      <div class="question-card" data-qindex="2">
        <div class="q-part">Part A Â· Listening Â· Q2/5</div>
        <div class="q-header">2. å¬å¥å­ï¼Œé€‰å‡ºä½ å¬åˆ°çš„å¥å­ã€‚</div>
        <div class="q-body">
          <button type="button" class="play-btn" data-tts="Good afternoon, Mom.">â–¶ æ’­æ”¾</button>
          <div class="options">
            <label><input type="radio" name="L2" value="A"> Good morning, Mom.</label>
            <label><input type="radio" name="L2" value="B"> Goodbye, Mom.</label>
            <label><input type="radio" name="L2" value="C"> Good afternoon, Mom.</label>
          </div>
        </div>
        <div class="q-nav">
          <button type="button" onclick="goPrev()">ä¸Šä¸€é¢˜</button>
          <button type="button" onclick="goNext()">ä¸‹ä¸€é¢˜</button>
        </div>
      </div>

      <!-- Listening Q3 -->
      <div class="question-card" data-qindex="3">
        <div class="q-part">Part A Â· Listening Â· Q3/5</div>
        <div class="q-header">3. å¬å¥å­ï¼Œé€‰å‡ºä½ å¬åˆ°çš„å‘Šåˆ«è¯­ã€‚</div>
        <div class="q-body">
          <button type="button" class="play-btn" data-tts="Goodbye, Li Li.">â–¶ æ’­æ”¾</button>
          <div class="options">
            <label><input type="radio" name="L3" value="A"> Good morning, Li Li.</label>
            <label><input type="radio" name="L3" value="B"> Goodbye, Li Li.</label>
            <label><input type="radio" name="L3" value="C"> Good afternoon, Li Li.</label>
          </div>
        </div>
        <div class="q-nav">
          <button type="button" onclick="goPrev()">ä¸Šä¸€é¢˜</button>
          <button type="button" onclick="goNext()">ä¸‹ä¸€é¢˜</button>
        </div>
      </div>

      <!-- Listening Q4 -->
      <div class="question-card" data-qindex="4">
        <div class="q-part">Part A Â· Listening Â· Q4/5</div>
        <div class="q-header">4. å¬å¥å­ï¼Œé€‰å‡ºä½ å¬åˆ°çš„å¥å­ã€‚</div>
        <div class="q-body">
          <button type="button" class="play-btn" data-tts="Have a good day!">â–¶ æ’­æ”¾</button>
          <div class="options">
            <label><input type="radio" name="L4" value="A"> Good morning!</label>
            <label><input type="radio" name="L4" value="B"> How are you?</label>
            <label><input type="radio" name="L4" value="C"> Have a good day!</label>
          </div>
        </div>
        <div class="q-nav">
          <button type="button" onclick="goPrev()">ä¸Šä¸€é¢˜</button>
          <button type="button" onclick="goNext()">ä¸‹ä¸€é¢˜</button>
        </div>
      </div>

      <!-- Listening Q5 -->
      <div class="question-card" data-qindex="5">
        <div class="q-part">Part A Â· Listening Â· Q5/5</div>
        <div class="q-header">5. å¬ä¸€å¬ï¼Œå¯¹è¯é€‰ç­”è¯­ã€‚</div>
        <div class="q-body">
          <button type="button" class="play-btn" data-tts="Good afternoon, Li Li. How are you?">â–¶ æ’­æ”¾</button>
          <div class="options">
            <label><input type="radio" name="L5" value="A"> Iâ€™m fine. Thank you.</label>
            <label><input type="radio" name="L5" value="B"> Goodbye.</label>
            <label><input type="radio" name="L5" value="C"> Have a good day.</label>
          </div>
        </div>
        <div class="q-nav">
          <button type="button" onclick="goPrev()">ä¸Šä¸€é¢˜</button>
          <button type="button" onclick="goNext()">ä¸‹ä¸€é¢˜</button>
        </div>
      </div>

      <!-- Reading Q1 -->
      <div class="question-card" data-qindex="6">
        <div class="q-part">Part B Â· Reading Â· Q1/5</div>
        <div class="q-header">6. è¯»ä¸€è¯»ï¼Œé€‰å‡ºæœ€ä½³ç­”è¯­ã€‚</div>
        <div class="q-body">
          <p>â€” Good morning, Mom.</p>
          <div class="options">
            <label><input type="radio" name="R1" value="A"> Goodbye.</label>
            <label><input type="radio" name="R1" value="B"> Good morning.</label>
            <label><input type="radio" name="R1" value="C"> Good afternoon.</label>
          </div>
        </div>
        <div class="q-nav">
          <button type="button" onclick="goPrev()">ä¸Šä¸€é¢˜</button>
          <button type="button" onclick="goNext()">ä¸‹ä¸€é¢˜</button>
        </div>
      </div>

      <!-- Reading Q2 -->
      <div class="question-card" data-qindex="7">
        <div class="q-part">Part B Â· Reading Â· Q2/5</div>
        <div class="q-header">7. è¯»ä¸€è¯»ï¼Œé€‰å‡ºæœ€ä½³ç­”è¯­ã€‚</div>
        <div class="q-body">
          <p>â€” Goodbye, Li Li.</p>
          <div class="options">
            <label><input type="radio" name="R2" value="A"> Goodbye.</label>
            <label><input type="radio" name="R2" value="B"> Good morning.</label>
            <label><input type="radio" name="R2" value="C"> Have a good day.</label>
          </div>
        </div>
        <div class="q-nav">
          <button type="button" onclick="goPrev()">ä¸Šä¸€é¢˜</button>
          <button type="button" onclick="goNext()">ä¸‹ä¸€é¢˜</button>
        </div>
      </div>

      <!-- Reading Q3 -->
      <div class="question-card" data-qindex="8">
        <div class="q-part">Part B Â· Reading Â· Q3/5</div>
        <div class="q-header">8. è¯»ä¸€è¯»ï¼Œé€‰å‡ºæœ€ä½³ç­”è¯­ã€‚</div>
        <div class="q-body">
          <p>â€” Have a good day, Li Li!</p>
          <div class="options">
            <label><input type="radio" name="R3" value="A"> Thank you, you too!</label>
            <label><input type="radio" name="R3" value="B"> Iâ€™m fine.</label>
            <label><input type="radio" name="R3" value="C"> Good morning.</label>
          </div>
        </div>
        <div class="q-nav">
          <button type="button" onclick="goPrev()">ä¸Šä¸€é¢˜</button>
          <button type="button" onclick="goNext()">ä¸‹ä¸€é¢˜</button>
        </div>
      </div>

      <!-- Reading Q4 -->
      <div class="question-card" data-qindex="9">
        <div class="q-part">Part B Â· Reading Â· Q4/5</div>
        <div class="q-header">9. åˆ¤æ–­æ­£è¯¯ï¼Œæ­£ç¡®å†™ Tï¼Œé”™è¯¯å†™ Fã€‚</div>
        <div class="q-body">
          <p>â€œGoodbye.â€ çš„æ„æ€æ˜¯â€œå†è§â€ã€‚</p>
          <div class="options">
            <label><input type="radio" name="R4" value="T"> T</label>
            <label><input type="radio" name="R4" value="F"> F</label>
          </div>
        </div>
        <div class="q-nav">
          <button type="button" onclick="goPrev()">ä¸Šä¸€é¢˜</button>
          <button type="button" onclick="goNext()">ä¸‹ä¸€é¢˜</button>
        </div>
      </div>

      <!-- Reading Q5 -->
      <div class="question-card" data-qindex="10">
        <div class="q-part">Part B Â· Reading Â· Q5/5</div>
        <div class="q-header">10. åˆ¤æ–­æ­£è¯¯ï¼Œæ­£ç¡®å†™ Tï¼Œé”™è¯¯å†™ Fã€‚</div>
        <div class="q-body">
          <p>â€œGood afternoon.â€ ä¸€èˆ¬åœ¨ä¸‹åˆè¯´ã€‚</p>
          <div class="options">
            <label><input type="radio" name="R5" value="T"> T</label>
            <label><input type="radio" name="R5" value="F"> F</label>
          </div>
        </div>
        <div class="q-nav">
          <button type="button" onclick="goPrev()">ä¸Šä¸€é¢˜</button>
          <button type="button" onclick="goNext()">ä¸‹ä¸€é¢˜</button>
        </div>
      </div>

      <!-- Writing Q1 -->
      <div class="question-card" data-qindex="11">
        <div class="q-part">Part C Â· Writing Â· Q1/5</div>
        <div class="q-header">11. é€‰å‡ºå†™å¾—æœ€æ­£ç¡®çš„ä¸€å¥ã€‚ï¼ˆæ³¨æ„å¤§å†™å’Œç‚¹å·ï¼‰</div>
        <div class="q-body">
          <div class="options">
            <label><input type="radio" name="W1" value="A"> Good morning.</label>
            <label><input type="radio" name="W1" value="B"> good morning.</label>
            <label><input type="radio" name="W1" value="C"> Good morning</label>
          </div>
        </div>
        <div class="q-nav">
          <button type="button" onclick="goPrev()">ä¸Šä¸€é¢˜</button>
          <button type="button" onclick="goNext()">ä¸‹ä¸€é¢˜</button>
        </div>
      </div>

      <!-- Writing Q2 -->
      <div class="question-card" data-qindex="12">
        <div class="q-part">Part C Â· Writing Â· Q2/5</div>
        <div class="q-header">12. é€‰å‡ºå†™å¾—æœ€æ­£ç¡®çš„ä¸€å¥ã€‚ï¼ˆæ³¨æ„é€—å·å’Œæ„Ÿå¹å·ï¼‰</div>
        <div class="q-body">
          <div class="options">
            <label><input type="radio" name="W2" value="A"> Thank you, you too!</label>
            <label><input type="radio" name="W2" value="B"> thank you, you too!</label>
            <label><input type="radio" name="W2" value="C"> Thank you you too.</label>
          </div>
        </div>
        <div class="q-nav">
          <button type="button" onclick="goPrev()">ä¸Šä¸€é¢˜</button>
          <button type="button" onclick="goNext()">ä¸‹ä¸€é¢˜</button>
        </div>
      </div>

      <!-- Writing Q3 -->
      <div class="question-card" data-qindex="13">
        <div class="q-part">Part C Â· Writing Â· Q3/5</div>
        <div class="q-header">13. é€‰å‡ºè¯åºæ­£ç¡®çš„ä¸€å¥ã€‚</div>
        <div class="q-body">
          <div class="options">
            <label><input type="radio" name="W3" value="A"> Have a good day.</label>
            <label><input type="radio" name="W3" value="B"> Have good a day.</label>
            <label><input type="radio" name="W3" value="C"> a Have good day.</label>
          </div>
        </div>
        <div class="q-nav">
          <button type="button" onclick="goPrev()">ä¸Šä¸€é¢˜</button>
          <button type="button" onclick="goNext()">ä¸‹ä¸€é¢˜</button>
        </div>
      </div>

      <!-- Writing Q4 -->
      <div class="question-card" data-qindex="14">
        <div class="q-part">Part C Â· Writing Â· Q4/5</div>
        <div class="q-header">14. é€‰å­—æ¯å¡«ç©ºï¼Œè¡¥å…¨å•è¯ã€‚</div>
        <div class="q-body">
          <p>g__d morning.</p>
          <div class="options">
            <label><input type="radio" name="W4" value="A"> a a</label>
            <label><input type="radio" name="W4" value="B"> o o</label>
            <label><input type="radio" name="W4" value="C"> e e</label>
          </div>
        </div>
        <div class="q-nav">
          <button type="button" onclick="goPrev()">ä¸Šä¸€é¢˜</button>
          <button type="button" onclick="goNext()">ä¸‹ä¸€é¢˜</button>
        </div>
      </div>

      <!-- Writing Q5 -->
      <div class="question-card" data-qindex="15">
        <div class="q-part">Part C Â· Writing Â· Q5/5</div>
        <div class="q-header">15. é€‰å­—æ¯å¡«ç©ºï¼Œè¡¥å…¨å•è¯ã€‚</div>
        <div class="q-body">
          <p>Good aftern___n.</p>
          <div class="options">
            <label><input type="radio" name="W5" value="A"> o o</label>
            <label><input type="radio" name="W5" value="B"> e e</label>
            <label><input type="radio" name="W5" value="C"> a a</label>
          </div>
        </div>
        <div class="q-nav">
          <button type="button" onclick="goPrev()">ä¸Šä¸€é¢˜</button>
          <button type="button" onclick="manualSubmit()">æäº¤ç­”å·</button>
        </div>
      </div>
    </div>

    <!-- ç»“æœåŒºåŸŸ -->
    <div id="result-box">
      <div id="result-text"></div>
      <div id="result-detail" class="note"></div>
      <button id="nextStudentBtn" style="margin-top:6px;">ä¸‹ä¸€ä½åŒå­¦ä½œç­”</button>
    </div>

    <!-- è€å¸ˆå·¥å…·ï¼šå¯¼å‡ºå…¨éƒ¨æˆç»© -->
    <div id="teacher-tools">
      <p>ğŸ‘©â€ğŸ« è€å¸ˆå·¥å…·ï¼šæœ¬è®¾å¤‡ä¸Šæ‰€æœ‰å·²å®Œæˆçš„å°æµ‹æˆç»©å¯ä»¥ä¸€èµ·å¯¼å‡ºã€‚</p>
      <button id="exportAllBtn">å¯¼å‡ºå…¨éƒ¨æˆç»©ï¼ˆCSVï¼‰</button>
    </div>
  </div>

  <script>
    // ========= å…¨å±€å˜é‡ =========
    let timer = null;
    let timeLeft = 540; // 9 åˆ†é’Ÿ
    let quizStarted = false;
    let quizFinished = false;
    let currentQ = 1;
    const totalQ = 15;

    let lastResult = null;
    let allResults = []; // å­˜æ”¾æœ¬è®¾å¤‡ä¸Šæ‰€æœ‰å­¦ç”Ÿçš„æˆç»©è®°å½•

    // æ­£ç¡®ç­”æ¡ˆï¼ˆæ¯é¢˜ 5 åˆ†ï¼‰
    const listeningAnswers = { L1: "A", L2: "C", L3: "B", L4: "C", L5: "A" };
    const readingAnswers   = { R1: "B", R2: "A", R3: "A", R4: "T", R5: "T" };
    const writingAnswers   = {
      W1: "A", // Good morning.
      W2: "A", // Thank you, you too!
      W3: "A", // Have a good day.
      W4: "B", // g__d -> oo
      W5: "A"  // aftern__n -> oo
    };

    // ========= ä¸€é¢˜ä¸€å±ï¼šæ˜¾ç¤ºé¢˜ç›® =========
    function showQuestion(index) {
      const cards = document.querySelectorAll(".question-card");
      cards.forEach(card => {
        const i = parseInt(card.getAttribute("data-qindex"), 10);
        card.classList.toggle("active", i === index);
      });
      currentQ = index;
      if (window.speechSynthesis) window.speechSynthesis.cancel();
      window.scrollTo(0, 0);
    }

    function goNext() {
      if (currentQ < totalQ) showQuestion(currentQ + 1);
    }
    function goPrev() {
      if (currentQ > 1) showQuestion(currentQ - 1);
    }

    // ========= å€’è®¡æ—¶ =========
    function updateTimerDisplay() {
      const minutes = String(Math.floor(timeLeft / 60)).padStart(2, "0");
      const seconds = String(timeLeft % 60).padStart(2, "0");
      const timerSpan = document.getElementById("timer");
      if (timerSpan) timerSpan.textContent = `${minutes}:${seconds}`;
    }

    function startCountdown() {
      updateTimerDisplay();
      timer = setInterval(() => {
        timeLeft--;
        if (timeLeft <= 0) {
          timeLeft = 0;
          updateTimerDisplay();
          clearInterval(timer);
          if (!quizFinished) {
            alert("æ—¶é—´åˆ°äº†ï¼Œè¿™æ¬¡å°æµ‹éªŒç»“æŸå•¦ï½è€å¸ˆä¼šå¸®ä½ çœ‹ä¸€çœ‹ç»“æœã€‚");
            submitAnswers();
          }
        } else {
          updateTimerDisplay();
        }
      }, 1000);
    }

    // ========= è¯­éŸ³æœ—è¯» =========
    function playTTS(text) {
      if (!window.speechSynthesis) {
        alert("å½“å‰æµè§ˆå™¨ä¸æ”¯æŒæœ—è¯»åŠŸèƒ½ã€‚");
        return;
      }
      window.speechSynthesis.cancel();
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = "en-US";
      window.speechSynthesis.speak(utter);
    }

    // ========= å·¥å…·å‡½æ•° =========
    function clearAnswers() {
      document.querySelectorAll('input[type="radio"]').forEach(input => {
        input.checked = false;
      });
    }

    function resetStateForNextStudent() {
      if (window.speechSynthesis) window.speechSynthesis.cancel();
      if (timer) {
        clearInterval(timer);
        timer = null;
      }
      timeLeft = 540;
      updateTimerDisplay();
      quizStarted = false;
      quizFinished = false;
      clearAnswers();
      document.getElementById("result-box").style.display = "none";
      document.getElementById("quiz-page").style.display = "none";
      document.getElementById("cover-page").style.display = "block";
      const select = document.getElementById("studentSelect");
      if (select) select.value = "";
      document.getElementById("studentNameDisplay").textContent = "";
      currentQ = 1;
    }

    // ========= æäº¤ä¸å¯¼å‡º =========
    function submitAnswers() {
      quizFinished = true;
      if (timer) {
        clearInterval(timer);
        timer = null;
      }
      if (window.speechSynthesis) window.speechSynthesis.cancel();

      let totalScore = 0;

      // Listening
      let listeningScore = 0;
      Object.keys(listeningAnswers).forEach(id => {
        const sel = document.querySelector(`input[name="${id}"]:checked`);
        if (sel && sel.value === listeningAnswers[id]) listeningScore += 5;
      });
      totalScore += listeningScore;

      // Reading
      let readingScore = 0;
      Object.keys(readingAnswers).forEach(id => {
        const sel = document.querySelector(`input[name="${id}"]:checked`);
        if (sel && sel.value === readingAnswers[id]) readingScore += 5;
      });
      totalScore += readingScore;

      // Writing
      let writingScore = 0;
      Object.keys(writingAnswers).forEach(id => {
        const sel = document.querySelector(`input[name="${id}"]:checked`);
        if (sel && sel.value === writingAnswers[id]) writingScore += 5;
      });
      totalScore += writingScore;

      const percent = Math.round(totalScore / 75 * 100);

      let levelText = "";
      if (percent >= 90) levelText = "è¡¨ç°éå¸¸æ£’ï¼Œå¯ä»¥è‡ªä¿¡ä½¿ç”¨è¿™äº›é—®å€™å’Œå‘Šåˆ«è¯­äº†ï¼";
      else if (percent >= 75) levelText = "æ•´ä½“å¾ˆå¥½ï¼Œå†å¤šç»ƒå‡ æ¬¡å°±æ›´ç†Ÿç»ƒå•¦ã€‚";
      else if (percent >= 60) levelText = "åŸºæœ¬è¾¾æ ‡ï¼Œå¯ä»¥é‡ç‚¹å¤ä¹ æ²¡æŠŠæ¡çš„é¢˜ç›®ã€‚";
      else levelText = "å»ºè®®å†åšä¸€éé¢˜ç›®ï¼Œå¤šå¬å¤šè¯»ï¼Œä¼šè¶Šæ¥è¶Šå¥½ã€‚";

      const studentSelect = document.getElementById("studentSelect");
      const studentId = studentSelect && studentSelect.value ? studentSelect.value : "";
      const studentLabel = studentSelect && studentSelect.value
        ? studentSelect.options[studentSelect.selectedIndex].text
        : "(æœªé€‰æ‹©å­¦ç”Ÿ)";

      // æ˜¾ç¤ºåˆ°é¡µé¢
      const resultBox = document.getElementById("result-box");
      document.getElementById("result-text").textContent =
        `å­¦ç”Ÿï¼š${studentLabel} ï½œ æ€»åˆ†ï¼š${totalScore} / 75ï¼ˆ${percent}%ï¼‰`;
      document.getElementById("result-detail").innerHTML =
        `Listeningï¼š${listeningScore} åˆ†ï¼›Readingï¼š${readingScore} åˆ†ï¼›Writingï¼š${writingScore} åˆ†ã€‚<br>` +
        levelText;
      resultBox.style.display = "block";

      // ä¿å­˜åˆ° allResults
      const resultObj = {
        studentId,
        studentName: studentLabel,
        listeningScore,
        readingScore,
        writingScore,
        totalScore,
        percent,
        finishedAt: new Date().toISOString()
      };
      lastResult = resultObj;
      allResults.push(resultObj);

      // æ˜¾ç¤ºè€å¸ˆå·¥å…·
      const teacherTools = document.getElementById("teacher-tools");
      if (teacherTools) teacherTools.style.display = "block";
    }

    function manualSubmit() {
      if (!quizFinished && confirm("ç¡®è®¤è¦æäº¤è¿™æ¬¡ç­”å·å—ï¼Ÿ")) {
        submitAnswers();
      }
    }

    function exportAllCSV() {
      if (!allResults.length) {
        alert("è¿˜æ²¡æœ‰ä»»ä½•ç­”é¢˜è®°å½•å“¦ã€‚");
        return;
      }
      const header = [
        "student_id","student_name","total","percent",
        "listening","reading","writing","finished_at"
      ];
      const lines = [header.join(",")];

      allResults.forEach(r => {
        lines.push([
          r.studentId || "",
          `"${r.studentName || ""}"`,
          r.totalScore,
          r.percent,
          r.listeningScore,
          r.readingScore,
          r.writingScore,
          r.finishedAt
        ].join(","));
      });

      const csvContent = lines.join("\n");
      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "U1L4_all_results.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // ========= äº‹ä»¶ç»‘å®š =========
    window.addEventListener("DOMContentLoaded", () => {
      // æœ—è¯»æŒ‰é’®
      document.querySelectorAll(".play-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const text = btn.getAttribute("data-tts");
          playTTS(text);
        });
      });

      // å°é¢é¡µå¼€å§‹æŒ‰é’®
      document.getElementById("enterBtn").addEventListener("click", () => {
        const studentSelect = document.getElementById("studentSelect");
        if (!studentSelect.value) {
          alert("è¯·å…ˆé€‰æ‹©ä½ çš„åå­—ï¼Œå†å¼€å§‹ç­”é¢˜å“¦ï½");
          return;
        }

        // æ¯æ¬¡å¼€å§‹å‰å…ˆæ¸…ç©ºä¸Šä¸€æ¬¡ç­”é¢˜ç—•è¿¹ï¼ˆç»™ä¸‹ä¸€ä½åŒå­¦å‡†å¤‡ï¼‰
        clearAnswers();
        quizStarted = true;
        quizFinished = false;
        timeLeft = 540;
        updateTimerDisplay();

        const label = studentSelect.options[studentSelect.selectedIndex].text;
        document.getElementById("studentNameDisplay").textContent = label;

        document.getElementById("cover-page").style.display = "none";
        document.getElementById("quiz-page").style.display = "block";

        showQuestion(1);
        startCountdown();
      });

      // ä¸‹ä¸€ä½åŒå­¦
      document.getElementById("nextStudentBtn").addEventListener("click", () => {
        resetStateForNextStudent();
      });

      // å¯¼å‡ºå…¨éƒ¨æˆç»©
      document.getElementById("exportAllBtn").addEventListener("click", exportAllCSV);
    });
  </script>
</body>
</html>
