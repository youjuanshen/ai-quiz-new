<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grade 3 English Quiz (Unit 1-2)</title>
    <style>
        /* ---------------- CSS æ ·å¼éƒ¨åˆ† ---------------- */
        body {
            font-family: 'Comic Sans MS', 'Arial', sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 800px;
            position: relative;
        }

        /* å°é¢é¡µæ ·å¼ */
        #coverPage {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            text-align: center;
        }

        h1, h2, h3 { color: #333; }
        
        select, input[type="text"] {
            padding: 10px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
            width: 80%;
            margin-top: 10px;
        }

        button {
            padding: 12px 24px;
            font-size: 18px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            transition: all 0.3s;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        /* é¡¶éƒ¨å›ºå®šæ¡ */
        #fixedHeader {
            display: none; /* å¼€å§‹åæ˜¾ç¤º */
            justify-content: space-between;
            align-items: center;
            background-color: #e3f2fd;
            padding: 10px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            border: 1px solid #b3e5fc;
        }

        #timerDisplay {
            font-weight: bold;
            color: #d32f2f;
            font-size: 1.2em;
        }

        /* é¢˜ç›®æ ·å¼ */
        .question-page {
            display: none;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .question-image-style {
            max-width: 100%;
            max-height: 250px;
            display: block;
            margin: 10px auto;
            border-radius: 8px;
            border: 1px solid #eee;
        }

        .option-image-style {
            width: 100px;
            height: 100px;
            object-fit: contain;
        }

        /* é€‰é¡¹æ ·å¼ */
        .answer-option {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .answer-option:hover { background-color: #f9f9f9; border-color: #bbb; }
        .selected-option {
            border-color: #007bff;
            background-color: #e7f1ff;
            font-weight: bold;
        }

        /* æ‹–æ‹½é¢˜æ ·å¼ */
        .drag-target {
            min-height: 60px;
            border: 2px dashed #007bff;
            border-radius: 8px;
            background-color: #f8f9fa;
            padding: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        .drag-item {
            background-color: #fff;
            border: 1px solid #ccc;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: move;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            user-select: none;
            margin: 5px;
        }

        /* åº•éƒ¨å¯¼èˆª */
        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }

        .prev-button { background-color: #6c757d; }
        .submit-button { background-color: #28a745; }

        /* æˆç»©å• */
        #scoreCard {
            display: none;
            text-align: center;
            padding: 40px;
        }
    </style>
</head>
<body>

<div class="container">
    <div id="coverPage">
        <h1>Grade 3 English Quiz (Unit 1-2)</h1>
        <p>Before we start, please tell me who you are:</p>
        
        <select id="studentSelector" onchange="enableStartButton()">
            <option value="" disabled selected>-- Select Your Name --</option>
            </select>

        <div style="margin-top: 20px;">
            <button id="startButton" disabled onclick="startQuiz()">Start Quiz (å¼€å§‹æµ‹éªŒ)</button>
        </div>
        
        <button id="exportButton" onclick="exportToCSV()" style="display:none; margin-top:30px; background-color: #17a2b8;">
            ğŸ“¥ å¯¼å‡ºæ‰€æœ‰æˆç»© (è€å¸ˆç”¨)
        </button>
    </div>

    <div id="fixedHeader">
        <span id="studentDisplay">åŒå­¦ï¼šæœªé€‰æ‹©</span>
        <span>å‰©ä½™æ—¶é—´: <span id="timerDisplay">09:00</span></span>
    </div>

    <div id="quizContainer" style="display: none;">
        </div>

    <div id="scoreCard">
        <h2>Quiz Completed!</h2>
        <div id="finalScore" style="font-size: 1.2em; margin: 20px 0;"></div>
        <p id="gradeFeedback" style="color: #666;"></p>
        <button onclick="resetForNextStudent()" style="margin-top: 20px;">Next Student (ä¸‹ä¸€ä½)</button>
    </div>
</div>

<script>
    // ------------------------- 0. Google Sheet é…ç½® -------------------------

    // *** å·²ç»æ›¿æ¢ä¸ºä½ æä¾›çš„æœ€æ–°é“¾æ¥ ***
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyaw5ooQdBTpcD0io6zDzWEzxhw9v7y1cr0cMkIqydaqXEtoIQrvuwJizKkzYkjEPI/exec';

    // ------------------------- 1. æ•°æ®å®šä¹‰ -------------------------

    // ç¤ºä¾‹å­¦ç”Ÿåå•ï¼ˆæŒ‰éœ€ä¿®æ”¹ï¼‰
    const studentList = [
        { id: '01', name: 'ææ˜' },
        { id: '02', name: 'ç‹èŠ³' },
        { id: '03', name: 'å¼ å°å' },
        { id: '04', name: 'åˆ˜æ´‹' },
        { id: '05', name: 'é™ˆæ€æ€' },
        { id: '06', name: 'èµµä¿Š' },
        { id: '07', name: 'å­™æ‚¦' }
    ];

    // *** å›¾ç‰‡è·¯å¾„é…ç½® (å·²æ ¹æ®ä½ çš„æˆªå›¾ä¿®æ­£æ–‡ä»¶å) ***
    const imageUris = {
        // æ•°é‡å›¾ç‰‡
        '3 Items': 'img/num_03.png',
        '4 Items': 'img/num_04.png',
        '5 Items': 'img/num_05.png',
        '9 Items': 'img/num_09.png',
        '10 Items': 'img/num_10.png',
        '2 Items': 'img/num_02.png',
        '1 Item': 'img/num_01.png',
        '6 Items': 'img/num_06.png',

        // é¢˜å¹²ç”¨çš„å›¾ç‰‡
        '4 Pencils': 'img/num_04.png',

        // *** æ³¨æ„ï¼šè¿™é‡Œæ”¹ä¸º cene_park.png ä»¥åŒ¹é…ä½ æˆªå›¾ä¸­çš„æ–‡ä»¶å ***
        'Park Scene': 'img/cene_park.png', 

        // å¥–ç« å›¾ç‰‡
        'Great Sign': 'img/badge_great.png',

        // Q15 æ˜¾ç¤ºæ•°å­— 5
        'Number 5': 'img/num_05.png'
    };

    // æµ‹éªŒé¢˜ç›®æ•°æ®
    const quizData = [
        // Part A: å¬åŠ› (Listening)
        { qNum: 1, part: 'A', type: 'select',
          text: 'è¯·ç‚¹å‡»å°å–‡å­å¬å½•éŸ³ï¼Œç„¶åé€‰æ‹©ä¸å½•éŸ³å†…å®¹åŒ¹é…çš„å›¾ç‰‡ã€‚',
          audioText: 'I have five ice creams.',
          options: [imageUris['3 Items'], imageUris['5 Items'], imageUris['9 Items'], imageUris['4 Items']],
          correct: imageUris['5 Items'],
          hint: 'æ³¨æ„æ•°å­— five å¯¹åº”å“ªä¸ªæ•°é‡ã€‚'
        },
        { qNum: 2, part: 'A', type: 'select',
          text: 'è¯·ç‚¹å‡»å°å–‡å­å¬å½•éŸ³ï¼Œç„¶åé€‰æ‹©ä¸å½•éŸ³å†…å®¹åŒ¹é…çš„å›¾ç‰‡ã€‚',
          audioText: 'Count the number to ten.',
          options: [imageUris['4 Items'], imageUris['5 Items'], imageUris['10 Items'], imageUris['2 Items']],
          correct: imageUris['10 Items'],
          hint: 'ä»”ç»†å¬æ•°å­—è¯ ten çš„å‘éŸ³ã€‚'
        },
        { qNum: 3, part: 'A', type: 'select',
          text: 'è¯·ç‚¹å‡»å°å–‡å­å¬å½•éŸ³ï¼Œç„¶åé€‰æ‹©ä¸å½•éŸ³å†…å®¹åŒ¹é…çš„ä¸­æ–‡æ„æ€ã€‚',
          audioText: "Let's play a game!",
          options: ['è®©æˆ‘ä»¬ç©æ¸¸æˆï¼', 'ä½ å«ä»€ä¹ˆåå­—ï¼Ÿ', 'è¿™æ˜¯æˆ‘çš„æœ‹å‹ã€‚', 'å¾ˆé«˜å…´è§åˆ°ä½ ï¼'],
          correct: 'è®©æˆ‘ä»¬ç©æ¸¸æˆï¼',
          hint: "å¥å‹ Let's ... è¡¨ç¤ºâ€œè®©æˆ‘ä»¬â€¦â€¦â€çš„æ„æ€ã€‚"
        },
        { qNum: 4, part: 'A', type: 'fill',
          text: 'è¯·ç‚¹å‡»å°å–‡å­å¬å½•éŸ³ï¼Œç„¶åè¾“å…¥å•è¯æ‹¼å†™ã€‚',
          audioText: 'The number is three.',
          correct: 'three',
          hint: 'è¿™ä¸ªæ•°å­—è¯ä»¥ t å¼€å¤´ã€‚'
        },
        { qNum: 5, part: 'A', type: 'fill',
          text: 'è¯·ç‚¹å‡»å°å–‡å­å¬å½•éŸ³ï¼Œç„¶åè¾“å…¥å•è¯æ‹¼å†™ã€‚',
          audioText: "OK, Let's play!",
          correct: 'play',
          hint: 'è¿™ä¸ªå•è¯æ˜¯è¡¨ç¤ºâ€œç©è€â€çš„åŠ¨è¯ã€‚'
        },

        // Part B: é˜…è¯» (Reading)
        { qNum: 6, part: 'B', type: 'drag-sort',
          text: 'è¯·å°†ä¸‹åˆ—è¯å—æ‹–æ‹½æ’åºï¼Œç»„æˆä¸€ä¸ªæ­£ç¡®çš„å¥å­ã€‚',
          words: ['apple', 'is', 'This', 'an', '.'],
          correct: 'This is an apple.',
          hint: 'å¥å‹ This is an...'
        },
        { qNum: 7, part: 'B', type: 'drag-sort',
          text: 'è¯·å°†ä¸‹åˆ—è¯å—æ‹–æ‹½æ’åºï¼Œç»„æˆä¸€ä¸ªæ­£ç¡®çš„å¥å­ã€‚',
          words: ['park.', "Let's", 'in the', 'play'],
          correct: "Let's play in the park.",
          hint: "å¥å­ Let's å¼€å¤´ã€‚"
        },
        { qNum: 8, part: 'B', type: 'select',
          text: 'è¯·é€‰æ‹©ä¸è‹±æ–‡æ•°å­—è¯æ±‡ "six" å¯¹åº”çš„æ•°é‡å›¾ç‰‡ã€‚',
          options: [imageUris['1 Item'], imageUris['9 Items'], imageUris['6 Items'], imageUris['2 Items']],
          correct: imageUris['6 Items'],
          hint: 'æ•°å­— six æ˜¯å‡ ï¼Ÿ'
        },
        { qNum: 9, part: 'B', type: 'fill',
          text: 'çœ‹å›¾å›ç­”é—®é¢˜ï¼Œç”¨ä¸€ä¸ªè‹±æ–‡å•è¯ä½œç­”ï¼šHow many ice creams?',
          imageUri: imageUris['4 Pencils'],
          correct: 'four',
          hint: 'å›¾ç‰‡ä¸­æ˜¯ 4 ä¸ªå†°æ¿€å‡Œã€‚'
        },
        { qNum: 10, part: 'B', type: 'select',
          text: 'çœ‹å›¾ï¼Œé€‰å‡ºè¿™ä¸ªåœºæ™¯å¯¹åº”çš„è‹±æ–‡å•è¯ã€‚',
          imageUri: imageUris['Park Scene'],
          options: ['school', 'park', 'home', 'zoo'],
          correct: 'park',
          hint: 'è¿™ä¸ªå•è¯æ˜¯ Unit 2 å­¦ä¹ çš„åœºæ™¯è¯ã€‚'
        },

        // Part C: å†™ä½œ (Writing)
        { qNum: 11, part: 'C', type: 'select',
          text: 'è¯·é€‰æ‹©æ•°å­— 7 å¯¹åº”çš„æ­£ç¡®è‹±æ–‡æ‹¼å†™ã€‚',
          options: ['seven', 'sevan', 'sewen', 'seve'],
          correct: 'seven',
          hint: 'è¯·å›å¿† seven çš„å…ƒéŸ³å­—æ¯ã€‚'
        },
        { qNum: 12, part: 'C', type: 'drag-sort',
          text: 'è¯·æ‹–æ‹½è¯å—ï¼Œå®Œæˆå¥å­ï¼šI can ___ the ___ from one to ten.',
          words: ['say', 'numbers', 'play', 'go'],
          correct: 'I can say the numbers from one to ten.',
          hint: 'â€œè¯´æ•°å­—â€çš„è‹±æ–‡æ˜¯ä»€ä¹ˆï¼Ÿ'
        },
        { qNum: 13, part: 'C', type: 'fill',
          text: 'è¯·æ‹¼å†™å‡ºæ•°å­— 8 çš„è‹±æ–‡å•è¯ã€‚',
          correct: 'eight',
          hint: 'è¿™ä¸ªå•è¯ä»¥ e å¼€å¤´ã€‚'
        },
        { qNum: 14, part: 'C', type: 'fill',
          text: 'çœ‹å›¾ï¼Œå½“ä½ è¯´â€œå¤ªæ£’äº†â€æ—¶ï¼Œå¯¹åº”çš„è‹±æ–‡å•è¯æ˜¯ä»€ä¹ˆï¼Ÿ',
          imageUri: imageUris['Great Sign'],
          correct: 'great',
          hint: 'è¿™æ˜¯ä¸€ä¸ªè¡¨ç¤ºèµæ‰¬çš„å•è¯ï¼Œä»¥ g å¼€å¤´ã€‚'
        },
        { qNum: 15, part: 'C', type: 'fill',
          text: "æ ¹æ®å›¾ç‰‡ (æ•°å­— 5)ï¼Œè¯·å®Œæˆå¥å­ï¼šIt's number _____ .",
          imageUri: imageUris['Number 5'],
          correct: 'five',
          hint: 'è¿™ä¸ªæ•°å­—æ˜¯ä»¥ f å¼€å¤´çš„ã€‚'
        }
    ];

    // ------------------------- 2. çŠ¶æ€å˜é‡ -------------------------

    let currentQuestionIndex = 1;
    const TOTAL_QUESTIONS = quizData.length;
    let timerInterval;
    let timeLeft = 540; // 9 åˆ†é’Ÿ
    let currentAnswers = {};
    let allStudentRecords = [];
    let draggedItem = null;

    // ------------------------- 3. æ ¸å¿ƒåŠŸèƒ½å‡½æ•° -------------------------

    // åˆå§‹åŒ–å­¦ç”Ÿä¸‹æ‹‰èœå•
    function populateStudents() {
        const selector = document.getElementById('studentSelector');
        studentList.forEach(student => {
            const option = document.createElement('option');
            option.value = student.id;
            option.textContent = `${student.id.padStart(2, '0')} ${student.name}`;
            selector.appendChild(option);
        });
        document.getElementById('exportButton').style.display = 'none';
    }

    // å¯ç”¨å¼€å§‹æŒ‰é’®
    function enableStartButton() {
        const selector = document.getElementById('studentSelector');
        const startButton = document.getElementById('startButton');
        if (selector.value) {
            startButton.disabled = false;
            startButton.style.backgroundColor = '#007bff';
        } else {
            startButton.disabled = true;
            startButton.style.backgroundColor = '#ccc';
        }
    }

    // å¯åŠ¨æµ‹éªŒ
    function startQuiz() {
        const studentId = document.getElementById('studentSelector').value;
        if (!studentId) {
            alert('è¯·å…ˆé€‰æ‹©ä½ çš„å§“åï¼');
            return;
        }

        renderAllQuestions();

        document.getElementById('coverPage').style.display = 'none';
        document.getElementById('quizContainer').style.display = 'block';
        document.getElementById('scoreCard').style.display = 'none';

        currentAnswers = {};
        timeLeft = 540;
        currentQuestionIndex = 1;

        const selectedStudent = studentList.find(s => s.id === studentId);
        document.getElementById('studentDisplay').textContent = `åŒå­¦ï¼š${selectedStudent.name}`;
        document.getElementById('fixedHeader').style.display = 'flex';

        startTimer();
        changeQuestion(1);
    }

    // è®¡æ—¶å™¨å‡½æ•°
    function startTimer() {
        clearInterval(timerInterval);
        const timerDisplay = document.getElementById('timerDisplay');

        timerInterval = setInterval(() => {
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                timerDisplay.textContent = '00:00';
                alert('æ—¶é—´åˆ°ï¼ç³»ç»Ÿå°†è‡ªåŠ¨æäº¤ç­”å·ã€‚');
                submitAnswers();
                return;
            }

            timeLeft--;
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }, 1000);
    }

    // åˆ‡æ¢é¢˜ç›®åˆ†é¡µ
    function changeQuestion(newIndex) {
        if (newIndex < 1 || newIndex > TOTAL_QUESTIONS) return;

        document.querySelectorAll('.question-page').forEach(el => el.style.display = 'none');
        currentQuestionIndex = newIndex;

        const newElement = document.getElementById(`question_page_${currentQuestionIndex}`);
        if (newElement) {
            newElement.style.display = 'block';
            window.scrollTo(0, 0);
        }
    }

    // æ¸²æŸ“æ‰€æœ‰é¢˜ç›®åˆ° DOM ä¸­
    function renderAllQuestions() {
        const container = document.getElementById('quizContainer');
        container.innerHTML = ''; // æ¸…é™¤æ—§é¢˜ç›®

        // é€é¢˜ç”Ÿæˆ
        quizData.forEach(q => {
            const qDiv = document.createElement('div');
            qDiv.id = `question_page_${q.qNum}`;
            qDiv.className = 'question-page';
            qDiv.style.display = 'none';

            let html = `<h3>Part ${q.part} - Q${q.qNum} (5åˆ†)</h3>`;
            html += `<div class="question-content" style="margin-bottom: 20px;">${q.text}</div>`;

            // é¢˜å¹²å›¾ç‰‡
            if (q.imageUri) {
                html += `<img src="${q.imageUri}" alt="é¢˜ç›®æ’å›¾" class="question-image-style" onerror="this.style.display='none';this.insertAdjacentHTML('afterend','<span style=\\'color:red\\'>[å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥imgæ–‡ä»¶å¤¹å’Œæ–‡ä»¶å]</span>')">`;
            }

            if (q.type === 'select') {
                if (q.audioText) {
                    const safeText = q.audioText.replace(/'/g, "\\'");
                    html += `<button class="speaker-button" onclick="speakText('${safeText}')">ğŸ”Š æ’­æ”¾è¯­éŸ³</button>`;
                }

                q.options.forEach(option => {
                    const isImage = (typeof option === 'string') &&
                        (option.indexOf('img/') === 0 || option.indexOf('data:image') === 0);

                    const displayContent = isImage
                        ? `<img src="${option}" alt="é€‰é¡¹å›¾" class="option-image-style" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCI+PHRleHQgeT0iNTAlIiB4PSI1MCUiIGR5PSIuM2VtIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj4/PC90ZXh0Pjwvc3ZnPg=='">`
                        : `<span class="answer-option-text">${option}</span>`;

                    const valueForData = option.toString().replace(/"/g, "&quot;");
                    const valueForClick = option.toString().replace(/'/g, "\\'");

                    html += `
                        <div class="answer-option" data-qnum="${q.qNum}" data-value="${valueForData}"
                             onclick="collectSelectAnswer(${q.qNum}, '${valueForClick}', this)">
                            ${displayContent}
                        </div>
                    `;
                });

            } else if (q.type === 'fill') {
                if (q.audioText) {
                    const safeText = q.audioText.replace(/'/g, "\\'");
                    html += `<button class="speaker-button" onclick="speakText('${safeText}')">ğŸ”Š æ’­æ”¾è¯­éŸ³</button>`;
                }
                html += `<input type="text" id="answer_Q${q.qNum}" class="fill-in-input"
                               oninput="collectFillAnswer(${q.qNum})"
                               placeholder="åœ¨æ­¤è¾“å…¥è‹±æ–‡å•è¯ (é™å°å†™)">`;

            } else if (q.type === 'drag-sort') {
                html += `<div id="sort_target_Q${q.qNum}" class="drag-target"
                             ondrop="dropSort(event, ${q.qNum})" ondragover="allowDrop(event)">
                             <span style="color:#999; width:100%; text-align:center;">å°†ä¸‹æ–¹è¯å—æ‹–æ‹½åˆ°æ­¤å¤„</span>
                          </div>`;
                html += `<h4>å¯é€‰è¯å—:</h4><div id="sort_source_Q${q.qNum}" style="margin-top: 10px;">`;
                q.words.forEach((item, index) => {
                    html += `<div id="sort_item_Q${q.qNum}_${index}" class="drag-item" draggable="true"
                                  data-value="${item.trim()}" ondragstart="dragStart(event)">${item}</div>`;
                });
                html += `</div>`;
            }

            // åˆ†é¡µæŒ‰é’®
            html += `<div class="navigation-buttons">`;
            if (q.qNum > 1) {
                html += `<button class="prev-button" onclick="changeQuestion(${q.qNum - 1})">ä¸Šä¸€é¢˜</button>`;
            }
            if (q.qNum < TOTAL_QUESTIONS) {
                html += `<button class="next-button" onclick="changeQuestion(${q.qNum + 1})">ä¸‹ä¸€é¢˜</button>`;
            } else {
                html += `<button class="submit-button" onclick="submitAnswers()">æäº¤ç­”å·</button>`;
            }
            html += `</div>`;

            qDiv.innerHTML = html;
            container.appendChild(qDiv);
        });
    }

    // ------------------------- 4. ç­”æ¡ˆæ”¶é›†ä¸è¯„åˆ† -------------------------

    function collectSelectAnswer(qNum, value, element) {
        document.querySelectorAll(`.answer-option[data-qnum="${qNum}"]`).forEach(opt => {
            opt.classList.remove('selected-option');
        });
        element.classList.add('selected-option');
        currentAnswers[`Q${qNum}`] = value;
    }

    function collectFillAnswer(qNum) {
        const inputElement = document.getElementById(`answer_Q${qNum}`);
        if (inputElement) {
            const value = inputElement.value.trim().toLowerCase();
            currentAnswers[`Q${qNum}`] = value;
        }
    }

    function collectDragSortAnswer(qNum) {
        const target = document.getElementById(`sort_target_Q${qNum}`);
        let sortedAnswer = '';
        Array.from(target.children).forEach(item => {
            if (item.classList.contains('drag-item')) {
                sortedAnswer += item.getAttribute('data-value') + ' ';
            }
        });
        currentAnswers[`Q${qNum}`] = sortedAnswer.trim();
    }

    function gradeQuiz(answers) {
        let score = 0;
        let correctness = {};
        let listeningScore = 0;
        let readingScore = 0;
        let writingScore = 0;

        quizData.forEach(q => {
            const qKey = `Q${q.qNum}`;
            let isCorrect = false;
            const studentAnswer = answers[qKey] || '';

            if (q.type === 'select' || q.type === 'fill') {
                isCorrect = (studentAnswer.toLowerCase() === q.correct.toLowerCase());
            } else if (q.type === 'drag-sort') {
                const cleanedStudent = studentAnswer.toLowerCase().replace(/[.,?!]/g, '').replace(/\s+/g, ' ');
                const cleanedCorrect = q.correct.toLowerCase().replace(/[.,?!]/g, '').replace(/\s+/g, ' ');
                isCorrect = (cleanedStudent === cleanedCorrect);
            }

            if (isCorrect) {
                score += 5;
                if (q.part === 'A') listeningScore += 5;
                else if (q.part === 'B') readingScore += 5;
                else if (q.part === 'C') writingScore += 5;
            }
            correctness[qKey] = isCorrect;
        });

        return { score, correctness, listeningScore, readingScore, writingScore };
    }

    // ------------------------- 5. å†™å…¥ Google Sheet + æäº¤é€»è¾‘ -------------------------

    function sendSummaryToGoogleSheet(summary) {
        try {
            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors', // é‡è¦ï¼šç»•è¿‡è·¨åŸŸé™åˆ¶ï¼Œåªå‘é€ä¸è¯»å–
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(summary)
            }).catch(function (err) {
                console.error('Fetch error:', err);
            });
        } catch (err) {
            console.error('Try-catch error:', err);
        }
    }

    function submitAnswers() {
        clearInterval(timerInterval);
        quizData.filter(q => q.type === 'drag-sort').forEach(q => {
            collectDragSortAnswer(q.qNum);
        });

        const result = gradeQuiz(currentAnswers);
        const score = result.score;
        const totalPercent = Math.round(score / (TOTAL_QUESTIONS * 5) * 100);

        const studentId = document.getElementById('studentSelector').value;
        const selector = document.getElementById('studentSelector');
        const optionText = selector.options[selector.selectedIndex].textContent; 
        const parts = optionText.split(' ');
        const studentName = parts[1] || optionText; 
        const studentLabel = (parts[0] || '') + (parts[1] || '');

        const record = {
            studentId,
            name: studentName,
            score,
            answers: { ...currentAnswers },
            correctness: result.correctness,
            listeningScore: result.listeningScore,
            readingScore: result.readingScore,
            writingScore: result.writingScore,
            totalPercent
        };
        allStudentRecords.push(record);

        const summaryForSheet = {
            studentLabel: studentLabel,
            totalScore: score,
            totalPercent: totalPercent,
            listeningScore: result.listeningScore,
            readingScore: result.readingScore,
            writingScore: result.writingScore
        };
        sendSummaryToGoogleSheet(summaryForSheet);

        displayScoreCard(score, studentName);

        if (allStudentRecords.length > 0) {
            document.getElementById('exportButton').style.display = 'block';
        }
    }

    function displayScoreCard(score, name) {
        document.getElementById('fixedHeader').style.display = 'none';
        document.querySelectorAll('.question-page').forEach(el => el.style.display = 'none');

        const scoreCard = document.getElementById('scoreCard');
        scoreCard.style.display = 'block';

        let grade = '';
        let feedback = '';

        if (score >= 60) {
            grade = 'A (Excellent!)';
            feedback = `ğŸ‰ Great job, ${name}! You are doing amazing!`;
        } else if (score >= 40) {
            grade = 'B (Good Job)';
            feedback = `ğŸŒŸ ${name}, well done! Keep practicing your numbers.`;
        } else {
            grade = 'C (Keep Trying)';
            feedback = `ğŸ’¡ ${name}, keep trying! Listen to the audio more.`;
        }

        document.getElementById('finalScore').innerHTML =
            `Your Score: <span style="color: #dc3545; font-size: 1.5em; font-weight: bold;">${score}</span> / 75 (${grade})`;
        document.getElementById('gradeFeedback').textContent = feedback;
    }

    function resetForNextStudent() {
        document.getElementById('quizContainer').style.display = 'none';
        document.getElementById('coverPage').style.display = 'flex';
        document.getElementById('scoreCard').style.display = 'none';
        document.getElementById('studentSelector').value = '';
        document.getElementById('startButton').disabled = true;
        document.getElementById('startButton').style.backgroundColor = '#ccc';
        window.scrollTo(0, 0);
    }

    // ------------------------- 6. è¾…åŠ©åŠŸèƒ½ -------------------------

    function speakText(text) {
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.9;
            utterance.pitch = 1.0;
            utterance.lang = 'en-US';
            window.speechSynthesis.speak(utterance);
        } else {
            alert('Browser does not support text-to-speech.');
        }
    }

    function dragStart(event) {
        draggedItem = event.target;
        event.dataTransfer.setData('text/plain', draggedItem.id);
        setTimeout(() => { draggedItem.style.opacity = '0.5'; }, 0);
    }

    function allowDrop(event) {
        event.preventDefault();
    }

    function dropSort(event, qNum) {
        event.preventDefault();
        if (!draggedItem) return;
        draggedItem.style.opacity = '1';
        
        const target = event.currentTarget; 
        if (target.id.startsWith('sort_target_Q') || target.classList.contains('drag-item') || target.id.startsWith('sort_source_Q')) {
             if(target.classList.contains('drag-item')){
                 target.parentNode.insertBefore(draggedItem, target);
             } else {
                 target.appendChild(draggedItem);
             }
            collectDragSortAnswer(qNum);
        }
    }

    function exportToCSV() {
        if (allStudentRecords.length === 0) {
            alert('No records yet!');
            return;
        }
        const headerFields = ['ID', 'Name', 'Total Score'];
        for (let i = 1; i <= TOTAL_QUESTIONS; i++) {
            headerFields.push(`Q${i} Answer`);
            headerFields.push(`Q${i} Correct`);
        }

        let csvContent = headerFields.join(',') + '\n';

        allStudentRecords.forEach(record => {
            let row = [`"${record.studentId}"`, `"${record.name}"`, record.score];
            for (let i = 1; i <= TOTAL_QUESTIONS; i++) {
                const qKey = `Q${i}`;
                let answer = record.answers[qKey] ? record.answers[qKey].toString().replace(/"/g, '""') : '';
                row.push(`"${answer}"`);
                row.push(record.correctness[qKey] ? 'Yes' : 'No');
            }
            csvContent += row.join(',') + '\n';
        });

        const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.setAttribute('href', url);
        a.setAttribute('download', `quiz_results_${new Date().toISOString().slice(0, 10)}.csv`);
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    document.addEventListener('DOMContentLoaded', () => {
        populateStudents();
    });
</script>

</body>
</html>
