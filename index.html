<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸‰å¹´çº§è‹±è¯­é—¯å…³èµ›</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* å¢åŠ å…³å¡é€‰æ‹©å™¨çš„æ ·å¼ */
        .selector-group {
            margin-bottom: 15px;
            text-align: left;
        }
        .selector-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
            display: block;
            font-weight: bold;
        }
        select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            background-color: white;
        }
    </style>
</head>
<body>

<div class="container">
    <div id="coverPage">
        <div class="hero-icon">ğŸ¦</div>
        <h1 class="main-title">ä¸‰å¹´çº§è‹±è¯­é—¯å…³èµ›</h1>
        
        <div class="welcome-card">
            <div class="selector-group">
                <label class="selector-label">ğŸ—ºï¸ ç¬¬ä¸€æ­¥ï¼šé€‰æ‹©æŒ‘æˆ˜å…³å¡</label>
                <select id="quizSelector" onchange="loadSelectedQuiz()">
                    <option value="" disabled selected>-- è¯·é€‰æ‹©å•å…ƒ --</option>
                    
                    <optgroup label="Unit 1: Meeting Friends">
                        <option value="u1_l1">U1 Lesson 1</option>
                        <option value="u1_l2">U1 Lesson 2</option>
                        <option value="u1_l3">U1 Lesson 3</option>
                        <option value="u1_l4">U1 Lesson 4</option>
                    </optgroup>

                    <optgroup label="Unit 2: Fun Numbers">
                        <option value="u2_l1">U2 Lesson 1</option>
                        <option value="u2_l2">U2 Lesson 2</option>
                        <option value="u2_l3">U2 Lesson 3</option>
                        <option value="u2_l4">U2 Lesson 4</option>
                    </optgroup>

                    <optgroup label="Unit 3: Colors Around Us">
                        <option value="u3_l1">U3 Lesson 1 (It's green)</option>
                        <option value="u3_l2">U3 Lesson 2</option>
                        <option value="u3_l3">U3 Lesson 3</option>
                        <option value="u3_l4">U3 Lesson 4</option>
                    </optgroup>

                    <optgroup label="Unit 4: Loving My Family">
                        <option value="u4_l1">U4 Lesson 1</option>
                        <option value="u4_l2">U4 Lesson 2</option>
                        <option value="u4_l3">U4 Lesson 3</option>
                        <option value="u4_l4">U4 Lesson 4</option>
                    </optgroup>
                </select>
            </div>

            <div class="mission-box" id="statusBox" style="display:none; margin-top:10px;">
                <div class="mission-label">å½“å‰åŠ è½½ï¼š</div>
                <div id="missionTitle" class="mission-content">ç­‰å¾…é€‰æ‹©...</div>
            </div>

            <div class="selector-group" style="margin-top: 20px;">
                <label class="selector-label">ğŸ‘‹ ç¬¬äºŒæ­¥ï¼šæ‰¾åˆ°ä½ çš„åå­—</label>
                <select id="studentSelector" onchange="checkStartReady()" disabled>
                    <option value="" disabled selected>-- (è¯·å…ˆé€‰æ‹©å…³å¡) --</option>
                </select>
            </div>
        </div>

        <button id="startButton" disabled onclick="startQuiz()">ğŸš€ å‡†å¤‡å¥½äº†ï¼Œå¼€å§‹ï¼</button>
    </div>

    <div id="fixedHeader">
        <div class="header-left">
            <span class="student-badge">ğŸ‘¤ <span id="studentDisplay">åŒå­¦</span></span>
        </div>
        <div class="header-right">
            â³ <span id="timerDisplay">09:00</span>
        </div>
    </div>

    <div id="quizContainer"></div>

    <div id="scoreCard">
        <div class="result-icon">ğŸ‰</div>
        <h2>æŒ‘æˆ˜å®Œæˆï¼</h2>
        <div class="score-box">
            <div id="finalScore">?</div>
            <div class="total-mark">/ 75 åˆ†</div>
        </div>
        <div id="timeTakenDisplay" style="color:#888; margin:10px 0;">ç”¨æ—¶: --åˆ†--ç§’</div>
        <p id="gradeFeedback">è¯„ä»·åŠ è½½ä¸­...</p>
        <button class="restart-btn" onclick="resetForNextStudent()">ä¸‹ä¸€ä½åŒå­¦</button>
        <button id="exportButton" onclick="exportToCSV()" class="teacher-btn">ğŸ“¥ è€å¸ˆå¯¼å‡ºæ•°æ®</button>
    </div>
</div>

<div id="loadingOverlay">
    <div class="spinner"></div>
    <p>æ­£åœ¨å¤„ç†...</p>
</div>

<script>
    // 1. æ£€æŸ¥ç½‘å€æ˜¯å¦æœ‰ ?id=...
    // å¦‚æœæœ‰ï¼Œå°±è‡ªåŠ¨é”å®šé‚£ä¸ªå•å…ƒï¼›å¦‚æœæ²¡æœ‰ï¼Œå°±å…è®¸ç”¨æˆ·è‡ªå·±é€‰ã€‚
    const urlParams = new URLSearchParams(window.location.search);
    const quizIdFromUrl = urlParams.get('id');
    const quizSelector = document.getElementById('quizSelector');

    window.onload = function() {
        if (quizIdFromUrl) {
            // å¦‚æœæ˜¯è€å¸ˆå‘çš„æŒ‡å®šé“¾æ¥ (ä¾‹å¦‚ ?id=u3_l1)
            quizSelector.value = quizIdFromUrl;
            quizSelector.disabled = true; // é”å®šä¸‹æ‹‰æ¡†ï¼Œä¸è®©å­¦ç”Ÿä¹±æ”¹
            loadSelectedQuiz(quizIdFromUrl);
        }
    };

    // 2. åŠ¨æ€åŠ è½½ JS æ–‡ä»¶çš„å‡½æ•°
    function loadSelectedQuiz(manualId) {
        const fileId = manualId || quizSelector.value;
        if (!fileId) return;

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const statusBox = document.getElementById('statusBox');
        const titleEl = document.getElementById('missionTitle');
        statusBox.style.display = 'block';
        titleEl.textContent = "æ­£åœ¨è¯»å–é¢˜ç›®...";
        titleEl.style.color = "#999";

        // ç§»é™¤æ—§è„šæœ¬ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        const oldScript = document.getElementById('dynamic-quiz-script');
        if (oldScript) oldScript.remove();

        // åˆ›å»ºæ–°è„šæœ¬æ ‡ç­¾
        const script = document.createElement('script');
        script.id = 'dynamic-quiz-script';
        script.src = fileId + ".js"; // ä¾‹å¦‚ u3_l1.js
        
        script.onload = function() {
            console.log("âœ… è„šæœ¬åŠ è½½æˆåŠŸ: " + fileId);
            titleEl.style.color = "#333";
            // æ­¤æ—¶ u3_l1.js é‡Œçš„ initQuizSystem ä¼šè‡ªåŠ¨è¿è¡Œï¼ˆå‰ææ˜¯æ‚¨ç”¨äº†åˆšæ‰é‚£ä¸ªä¿®å¤ç‰ˆJSï¼‰
            // æˆ–è€…æˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨è§¦å‘ä¸€ä¸‹ç•Œé¢æ›´æ–°ï¼š
            document.getElementById('studentSelector').disabled = false;
            // é‡æ–°å¡«å…¥å­¦ç”Ÿåå•ï¼ˆé˜²æ­¢ä¸‹æ‹‰æ¡†æ²¡åˆ·æ–°ï¼‰
            if (typeof populateStudents === 'function') {
                populateStudents(); 
            }
            // æ›´æ–°æ ‡é¢˜
            if (typeof QUIZ_CONFIG !== 'undefined') {
                titleEl.textContent = QUIZ_CONFIG.title;
            }
        };

        script.onerror = function() {
            titleEl.textContent = "âŒ æ‰¾ä¸åˆ°æ–‡ä»¶: " + fileId + ".js";
            titleEl.style.color = "red";
            alert("æŠ±æ­‰ï¼Œè¿™ä¸ªå•å…ƒçš„é¢˜ç›®è¿˜æ²¡ä¸Šä¼ å“¦ï¼\næ–‡ä»¶ååº”è¯¥æ˜¯: " + fileId + ".js");
        };

        document.body.appendChild(script);
    }

    // 3. æ£€æŸ¥æ˜¯å¦å¯ä»¥å¼€å§‹
    function checkStartReady() {
        const studentVal = document.getElementById('studentSelector').value;
        const quizVal = document.getElementById('quizSelector').value;
        if (studentVal && quizVal) {
            document.getElementById('startButton').disabled = false;
        }
    }
</script>

</body>
</html>
