<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¬”è¯•æŒ‘æˆ˜èµ›</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body { font-family: 'Comic Sans MS', sans-serif; background-color: #fff3e0; margin: 0; padding: 20px; color: #333; }
        .home-link { position: fixed; top: 15px; left: 15px; z-index: 1000; background-color: #607d8b; color: white; text-decoration: none; padding: 8px 15px; border-radius: 20px; font-size: 14px; font-weight: bold; }
        .container { max-width: 800px; margin: 0 auto; padding-top: 40px; }
        .welcome-card { background: white; border-radius: 20px; padding: 30px; margin: 0 auto; max-width: 500px; box-shadow: 0 8px 20px rgba(0,0,0,0.08); border: 4px solid #fff; text-align: center; }
        .hero-icon { font-size: 60px; margin-bottom: 10px; }
        .main-title { color: #fb8c00; margin: 0 0 20px 0; }
        .selector-group { text-align: left; margin-bottom: 20px; }
        select { width: 100%; padding: 12px; font-size: 16px; border: 2px solid #e0e0e0; border-radius: 10px; background: #fafafa; outline: none; }
        #startButton { background: #4caf50; color: white; border: none; padding: 15px 40px; border-radius: 30px; font-size: 18px; font-weight: bold; cursor: pointer; width: 100%; }
        #startButton:disabled { background: #ccc; cursor: not-allowed; }
        #fixedHeader { display: none; justify-content: space-between; align-items: center; position: sticky; top: 0; background: rgba(255,255,255,0.95); padding: 10px 20px; z-index: 99; border-radius: 0 0 15px 15px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .question-page { background: white; border-radius: 16px; padding: 20px; margin-bottom: 25px; border-left: 6px solid #fb8c00; }
        .answer-option { padding: 12px; border: 2px solid #eee; border-radius: 10px; cursor: pointer; background: white; transition: all 0.2s; }
        .selected-option { border-color: #fb8c00; background-color: #fff8e1; }
        .drag-target { border: 2px dashed #fb8c00; padding: 15px; min-height: 60px; margin-bottom: 15px; border-radius: 10px; display: flex; gap: 8px; flex-wrap: wrap; background: #fffde7; }
        .drag-source { display: flex; gap: 8px; flex-wrap: wrap; }
        .word-chip { padding: 8px 15px; background: #e0f7fa; border: 1px solid #4dd0e1; border-radius: 20px; cursor: pointer; font-weight: bold; color: #006064; user-select: none; }
        #scoreCard { display: none; text-align: center; background: white; padding: 40px; border-radius: 20px; margin: 20px auto; }
        .score-box { font-size: 60px; color: #fb8c00; font-weight: bold; margin: 20px 0; }
        .restart-btn { background: #2196f3; color: white; border: none; padding: 10px 25px; border-radius: 20px; cursor: pointer; font-size: 16px; }
        .loading { text-align: center; color: #999; margin-top: 10px; }
    </style>
</head>
<body>

<a href="index.html" class="home-link">ğŸ  è¿”å›å¤§å…</a>

<div class="container">
    <div id="coverPage">
        <div class="hero-icon">ğŸ“</div>
        <h1 class="main-title">ç¬”è¯•æŒ‘æˆ˜</h1>
        
        <div class="welcome-card">
            <div class="selector-group">
                <label>ğŸ—ºï¸ é€‰æ‹©å…³å¡</label>
                <select id="quizSelector" onchange="loadSelectedQuiz()">
                    <option value="" disabled selected>-- è¯·é€‰æ‹©å•å…ƒ --</option>
                    <optgroup label="Unit 1">
                        <option value="data/written/u1_l1.js">Unit 1 Lesson 1</option>
                    </optgroup>
                    <optgroup label="Unit 3">
                        <option value="data/written/u3_l1.js">Unit 3 Lesson 1</option>
                    </optgroup>
                </select>
            </div>
            
            <div id="statusBox" style="display:none; margin:10px 0;">
                <div id="missionTitle" class="loading">ç­‰å¾…åŠ è½½...</div>
            </div>

            <div class="selector-group">
                <label>ğŸ‘‹ é€‰æ‹©å§“å</label>
                <select id="studentSelector" onchange="checkStartReady()" disabled>
                    <option value="" disabled selected>-- (è¯·å…ˆé€‰è¯¾) --</option>
                </select>
            </div>
        </div>
        <button id="startButton" disabled onclick="startQuiz()">ğŸš€ å¼€å§‹è€ƒè¯•</button>
    </div>

    <div id="fixedHeader">
        <div>ğŸ‘¤ <span id="studentDisplay"></span></div>
        <div>â³ <span id="timerDisplay">00:00</span></div>
    </div>

    <div id="quizContainer"></div>

    <div id="scoreCard">
        <h2>æŒ‘æˆ˜å®Œæˆï¼</h2>
        <div class="score-box"><span id="finalScore">?</span> <span style="font-size:20px;color:#999">åˆ†</span></div>
        <p id="gradeFeedback"></p>
        <button class="restart-btn" onclick="location.reload()">ä¸‹ä¸€ä½</button>
    </div>
</div>

<div id="loadingOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:2000; justify-content:center; align-items:center; flex-direction:column;">
    <div style="font-size:40px;">ğŸ”„</div>
    <p>æ­£åœ¨æäº¤è¯•å·...</p>
</div>

<script>
    // ================= å…¨å±€é…ç½® =================
    // 27äººçœŸå®åå•
    const STUDENT_LIST = [
        "1. å¼ å®‡è±ª", "2. å¼ ä½³å¯’", "3. å¼ ç¿æ¸Š", "4. å¼ ç¾½éŸ¬", "5. å¼ ç¾èŒ¹",
        "6. å¼ å˜‰é’¦", "7. å¢æ¢¦å©·", "8. å¼ æ‚¦è±", "9. å¼ è¯­æ¶µ", "10. å¼ è‹±è±ª",
        "11. å¼ å¿—é¹", "12. å¼ æ™ºæ°", "13. å¼ æ¢“å©·", "14. å¼ å“çª", "15. å¼ è¯ºä¾",
        "16. å¼ é›¨æ³½", "17. å¼ ä¾å½¤", "18. å¼ è‰ºæ¥ ", "19. å¼ æ€å½¤", "20. å¼ å­è±ª",
        "21. å¼ æ¢“äº¦", "22. å¼ çš“é‘«", "23. å¼ é›¨æ¬£", "24. å¼ å¦‚æ¬£", "25. å¼ æŸæ¶µ",
        "26. å¼ æ¢“çº¯", "27. å¼ æ³½é‘«"
    ];
    
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxc8c4prsZZLY9vp-te4gH5twQNO1A8Ek3yROTNZeNs-7YhL60UojvMsQoceJUZ7LUP/exec";

    // ================= æ ¸å¿ƒé€»è¾‘ =================
    let currentQuizData = null;
    let currentAnswers = {};
    let timerInterval, timeLeft = 540;

    // 1. åŠ è½½æ–‡ä»¶
    function loadSelectedQuiz() {
        const filePath = document.getElementById('quizSelector').value;
        if(!filePath) return;

        const titleEl = document.getElementById('missionTitle');
        document.getElementById('statusBox').style.display = 'block';
        titleEl.innerText = "â³ æ­£åœ¨è¯»å–...";
        titleEl.style.color = "#999";
        
        currentQuizData = null; // æ¸…ç©ºæ—§æ•°æ®

        const script = document.createElement('script');
        script.src = filePath;
        
        script.onload = () => {
            // ğŸš¨ å…³é”®ä¿®å¤ï¼šç¡®ä¿æ•°æ®çœŸçš„è¿›æ¥äº†
            if (!currentQuizData) {
                titleEl.innerText = "âŒ æ•°æ®åŠ è½½å¤±è´¥ (æ ¼å¼é”™è¯¯)";
                titleEl.style.color = "red";
                alert("ä¸¥é‡é”™è¯¯ï¼šæ–‡ä»¶åŠ è½½äº†ï¼Œä½†æ²¡æœ‰æ•°æ®ã€‚\nè¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦åŒ…å« window.LOAD_QUIZ");
                return;
            }
            titleEl.innerText = "âœ… " + currentQuizData.title;
            titleEl.style.color = "#333";
            populateStudents();
            document.getElementById('studentSelector').disabled = false;
        };
        
        script.onerror = () => {
            titleEl.innerText = "âŒ æ‰¾ä¸åˆ°æ–‡ä»¶";
            titleEl.style.color = "red";
            alert("æ–‡ä»¶ä¸å­˜åœ¨ï¼è¯·æ£€æŸ¥è·¯å¾„: " + filePath);
        };
        
        document.body.appendChild(script);
    }

    // 2. æ¥æ”¶æ•°æ®æ¥å£
    window.LOAD_QUIZ = function(data) {
        console.log("æ•°æ®å·²æ¥æ”¶:", data);
        currentQuizData = data;
        if(data.timeLimit) timeLeft = data.timeLimit;
    };

    function populateStudents() {
        const sel = document.getElementById('studentSelector');
        sel.innerHTML = '<option value="" disabled selected>-- é€‰æ‹©å§“å --</option>';
        STUDENT_LIST.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s; opt.innerText = s;
            sel.appendChild(opt);
        });
    }

    function checkStartReady() {
        if(document.getElementById('studentSelector').value) document.getElementById('startButton').disabled = false;
    }

    // 3. å¼€å§‹è€ƒè¯•
    function startQuiz() {
        // ğŸš¨ é˜²å¾¡æ€§æ£€æŸ¥ï¼šé˜²æ­¢ç™½å±
        if (!currentQuizData || !currentQuizData.questions || currentQuizData.questions.length === 0) {
            alert("âŒ é”™è¯¯ï¼šè¿™å¥—è¯•å·é‡Œæ²¡æœ‰é¢˜ç›®æ•°æ® (questionsä¸ºç©º)ï¼è¯·æ£€æŸ¥ JS æ–‡ä»¶å†…å®¹ã€‚");
            return;
        }

        document.getElementById('coverPage').style.display = 'none';
        document.getElementById('quizContainer').style.display = 'block';
        document.getElementById('fixedHeader').style.display = 'flex';
        document.getElementById('studentDisplay').innerText = document.getElementById('studentSelector').value;
        
        renderQuestions();
        startTimer();
    }

    // 4. æ¸²æŸ“é¢˜ç›® (ä¿®å¤å˜é‡åä¸ä¸€è‡´é—®é¢˜)
    function renderQuestions() {
        const container = document.getElementById('quizContainer');
        container.innerHTML = '';

        currentQuizData.questions.forEach((q, idx) => {
            const div = document.createElement('div');
            div.className = 'question-page';
            
            let html = `<div style="color:#fb8c00;font-size:12px;font-weight:bold">Q${q.qNum} (${q.part || 'Part'})</div>`;
            html += `<div style="font-size:18px;font-weight:bold;margin:10px 0">${q.text}</div>`;

            // å›¾ç‰‡å¤„ç†
            let imgSrc = q.imageUri;
            if (q.imageKey && currentQuizData.images) imgSrc = currentQuizData.images[q.imageKey];
            
            if (imgSrc) {
                if (!imgSrc.startsWith('http') && !imgSrc.startsWith('img/')) imgSrc = 'img/' + imgSrc;
                html += `<div style="text-align:center"><img src="${imgSrc}" style="max-width:100%;max-height:150px;border-radius:8px" onerror="this.style.display='none'"></div>`;
            }

            // å¬åŠ›
            if (q.audioText) {
                html += `<div style="text-align:center;margin:10px 0"><button onclick="speak('${q.audioText.replace(/'/g, "\\'")}')" style="background:#e1f5fe;color:#0288d1;border:none;padding:5px 15px;border-radius:15px;cursor:pointer">ğŸ”Š æ’­æ”¾</button></div>`;
            }

            // é€‰é¡¹
            if (q.type === 'select') {
                html += `<div style="display:grid;gap:10px">`;
                q.options.forEach(opt => {
                    let disp = opt;
                    let val = opt;
                    if (opt.startsWith('image:')) {
                        let key = opt.split(':')[1];
                        let src = currentQuizData.images ? currentQuizData.images[key] : '';
                        if(src && !src.startsWith('img/')) src = 'img/' + src;
                        disp = `<img src="${src}" style="height:50px">`;
                        val = 'image:'+key;
                    }
                    else if (opt.includes('.png')) {
                        let src = opt;
                        if(!src.startsWith('img/')) src = 'img/' + src;
                         disp = `<img src="${src}" style="height:50px">`;
                    }
                    html += `<div class="answer-option" onclick="selectOption(${q.qNum}, '${val.replace(/'/g,"\\'")}', this)">${disp}</div>`;
                });
                html += `</div>`;
            } 
            else if (q.type === 'drag-sort') {
                html += `<div class="drag-target" id="target-${q.qNum}"></div>`;
                html += `<div class="drag-source" id="source-${q.qNum}">`;
                q.words.forEach(w => {
                    html += `<div class="word-chip" onclick="moveWord(this, 'source-${q.qNum}', 'target-${q.qNum}', ${q.qNum})">${w}</div>`;
                });
                html += `</div>`;
            }

            div.innerHTML = html;
            container.appendChild(div);
        });

        const btn = document.createElement('button');
        btn.innerText = "äº¤å· (Submit)";
        btn.style = "width:100%;padding:15px;background:#4caf50;color:white;border:none;border-radius:12px;margin-top:20px;font-size:18px;font-weight:bold;cursor:pointer";
        btn.onclick = submitAnswers;
        container.appendChild(btn);
    }

    function selectOption(q, v, el) {
        currentAnswers['Q'+q] = v;
        Array.from(el.parentElement.children).forEach(c => c.classList.remove('selected-option'));
        el.classList.add('selected-option');
    }

    function moveWord(el, sid, tid, q) {
        const s = document.getElementById(sid);
        const t = document.getElementById(tid);
        if(el.parentElement.id === sid) t.appendChild(el); else s.appendChild(el);
        const words = Array.from(t.children).map(c => c.innerText).join(' ');
        currentAnswers['Q'+q] = words;
    }

    function startTimer() {
        clearInterval(timerInterval);
        const disp = document.getElementById('timerDisplay');
        timerInterval = setInterval(() => {
            if(timeLeft<=0) { clearInterval(timerInterval); submitAnswers(); return; }
            timeLeft--;
            disp.innerText = `${Math.floor(timeLeft/60).toString().padStart(2,'0')}:${(timeLeft%60).toString().padStart(2,'0')}`;
        }, 1000);
    }

    function submitAnswers() {
        clearInterval(timerInterval);
        document.getElementById('loadingOverlay').style.display = 'flex';
        let score = 0;
        
        currentQuizData.questions.forEach((q, i) => {
            const ans = currentAnswers['Q'+q.qNum];
            let right = false;
            
            if(ans === q.correct) right = true;
            else if(q.type === 'drag-sort' && ans && ans.replace(/[.,?!]/g,'').trim() === q.correct.replace(/[.,?!]/g,'').trim()) right = true;

            if(right) score += 5;
            
            const card = document.getElementsByClassName('question-page')[i];
            const div = document.createElement('div');
            div.style.padding = "10px"; div.style.borderRadius = "5px"; div.style.marginTop = "10px";
            if(right) { div.style.background = "#e8f5e9"; div.innerText = "âœ… æ­£ç¡® (+5)"; }
            else { div.style.background = "#ffebee"; div.innerHTML = `âŒ é”™è¯¯ <br><small>æ­£ç¡®ç­”æ¡ˆ: ${q.correct.replace('image:', '')}</small>`; }
            card.appendChild(div);
        });

        const payload = {
            studentName: document.getElementById('studentSelector').value,
            examType: "Written",
            lessonTitle: currentQuizData.title,
            score: score,
            duration: "N/A",
            details: JSON.stringify(currentAnswers)
        };
        fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });

        setTimeout(() => {
            document.getElementById('loadingOverlay').style.display = 'none';
            document.getElementById('quizContainer').style.display = 'none';
            document.getElementById('fixedHeader').style.display = 'none';
            document.getElementById('scoreCard').style.display = 'block';
            document.getElementById('finalScore').innerText = score;
            
            let feedback = "åŠ æ²¹ï¼";
            if (score >= currentQuizData.questions.length * 5 * 0.9) feedback = "å¤ªæ£’äº†ï¼ğŸ‰";
            document.getElementById('gradeFeedback').innerText = feedback;
        }, 1000);
    }

    function speak(text) {
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'en-US'; u.rate = 0.8;
        window.speechSynthesis.speak(u);
    }
</script>
</body>
</html>
